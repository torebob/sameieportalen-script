<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dokumentversjonering</title>
  <style>
    :root {
      --primary: #007bff; --light: #f8f9fa; --border: #dee2e6;
      --success: #28a745; --danger: #dc3545; --info: #17a2b8;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; padding: 16px; background-color: var(--light); }
    h3 { margin-top: 0; }
    .container { max-width: 800px; margin: auto; }
    .document-list { list-style: none; padding: 0; }
    .document-item { background: white; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px; padding: 16px; }
    .doc-header { font-weight: bold; font-size: 1.1em; margin-bottom: 8px; }
    .actions button { margin-right: 8px; padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; cursor: pointer; }
    .upload-section { margin-top: 12px; border-top: 1px solid var(--border); padding-top: 12px; display: none; }
    .history-section { margin-top: 12px; display: none; }
    .history-table { width: 100%; border-collapse: collapse; }
    .history-table th, .history-table td { padding: 8px; border: 1px solid var(--border); text-align: left; }
    .status { margin-top: 16px; padding: 12px; border-radius: 4px; display: none; }
    .status.success { background-color: #d4edda; color: #155724; }
    .status.error { background-color: #f8d7da; color: #721c24; }
    .loader { text-align: center; padding: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h3>Dokumentversjonering</h3>
    <p>Last opp nye versjoner av styringsdokumenter. Eksisterende versjoner blir automatisk tatt vare på i Google Drive.</p>

    <div id="status" class="status"></div>
    <div id="loader" class="loader">Laster dokumenter...</div>
    <ul id="document-list" class="document-list"></ul>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function showStatus(message, isError = false) {
      const el = $('status');
      el.textContent = message;
      el.className = `status ${isError ? 'error' : 'success'}`;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 5000);
    }

    function toggleSection(rowNum, section) {
      const el = $(`${section}-${rowNum}`);
      el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    function renderDocuments(docs) {
      const listEl = $('document-list');
      listEl.innerHTML = '';
      $('loader').style.display = 'none';

      if (!docs || docs.error) {
        showStatus(docs.error || 'Kunne ikke laste dokumenter.', true);
        return;
      }
      if (docs.length === 0) {
        listEl.innerHTML = '<li>Fant ingen dokumenter som kan versjoneres. Sørg for at de har en gyldig "MasterURL" i Styringsdokumenter_Logg.</li>';
        return;
      }

      docs.forEach(doc => {
        const item = document.createElement('li');
        item.className = 'document-item';
        item.innerHTML = `
          <div class="doc-header">${doc.kategori}</div>
          <div class="actions">
            <button onclick="toggleSection(${doc.rowNum}, 'upload')">Last opp ny versjon</button>
            <button onclick="loadHistory('${doc.fileId}', ${doc.rowNum})">Vis historikk</button>
            <a href="${doc.masterUrl}" target="_blank">Åpne nåværende</a>
          </div>
          <div id="upload-${doc.rowNum}" class="upload-section">
            <input type="file" id="file-${doc.rowNum}">
            <button onclick="handleUpload('${doc.fileId}', ${doc.rowNum})">Lagre</button>
          </div>
          <div id="history-${doc.rowNum}" class="history-section">Laster historikk...</div>
        `;
        listEl.appendChild(item);
      });
    }

    function handleUpload(fileId, rowNum) {
        const fileInput = $(`file-${rowNum}`);
        const file = fileInput.files[0];
        if (!file) {
            showStatus('Vennligst velg en fil.', true);
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const base64Data = e.target.result.split(',')[1];
            showStatus('Laster opp, vennligst vent...');
            google.script.run
                .withSuccessHandler(response => {
                    if (response.ok) {
                        showStatus(response.message);
                        fileInput.value = ''; // Clear file input
                        toggleSection(rowNum, 'upload');
                        // Optionally, refresh history
                        if ($(`history-${rowNum}`).style.display === 'block') {
                          loadHistory(fileId, rowNum);
                        }
                    } else {
                        showStatus(response.error, true);
                    }
                })
                .withFailureHandler(err => showStatus(err.message, true))
                .updateDocumentVersion(fileId, base64Data, file.type, file.name, rowNum);
        };
        reader.readAsDataURL(file);
    }

    function loadHistory(fileId, rowNum) {
        toggleSection(rowNum, 'history');
        const historySection = $(`history-${rowNum}`);
        if (historySection.style.display === 'none') return; // Don't load if hiding

        historySection.innerHTML = 'Laster historikk...';
        google.script.run
            .withSuccessHandler(response => {
                if (response.ok) {
                    renderHistory(response.history, rowNum);
                } else {
                    historySection.innerHTML = `<span style="color:red;">${response.error}</span>`;
                }
            })
            .withFailureHandler(err => {
                historySection.innerHTML = `<span style="color:red;">${err.message}</span>`;
            })
            .getDocumentRevisionHistory(fileId);
    }

    function renderHistory(history, rowNum) {
        const historySection = $(`history-${rowNum}`);
        if (!history || history.length === 0) {
            historySection.innerHTML = 'Ingen historikk funnet for dette dokumentet.';
            return;
        }
        let table = `<table class="history-table">
                        <tr><th>Versjon</th><th>Dato</th><th>Endret av</th><th>Størrelse</th></tr>`;
        history.forEach(rev => {
            const date = new Date(rev.modifiedDate).toLocaleString('no-NO');
            const size = rev.fileSize ? `${(rev.fileSize / 1024).toFixed(1)} KB` : 'N/A';
            table += `<tr>
                        <td>${rev.version}</td>
                        <td>${date}</td>
                        <td>${rev.user}</td>
                        <td>${size}</td>
                      </tr>`;
        });
        table += '</table>';
        historySection.innerHTML = table;
    }

    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
      google.script.run
        .withSuccessHandler(renderDocuments)
        .withFailureHandler(err => {
            $('loader').style.display = 'none';
            showStatus(err.message, true);
        })
        .getVersionableDocuments();
    });
  </script>
</body>
</html>