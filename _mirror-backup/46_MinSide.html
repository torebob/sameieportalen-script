<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="utf-8">
    <title>Min Side - <?= appName ?></title>
    <base target="_top">
    <style>
      :root{--bg:#0b1220;--card:#0f172a;--muted:#94a3b8;--border:#1f2937;--primary:#3b82f6;--success:#10b981;--warning:#f59e0b;--danger:#ef4444}
      *{box-sizing:border-box}
      body{margin:0;padding:12px;font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,system-ui,sans-serif;background:var(--bg);color:#fff;line-height:1.5}
      main {max-width: 800px; margin: 2rem auto; padding: 2rem; background: var(--card); border-radius: 8px; border: 1px solid var(--border);}
      h1 { border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-top: 0; }
      .loading, .error { text-align: center; padding: 2rem; }
      .form-group{margin-bottom:1rem}
      .form-group label{display:block;margin-bottom:.5rem;color:var(--muted);font-size:14px}
      .form-group input{width:100%;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:#fff;font-size:16px}
      .form-group input:disabled{background:#2a3344;cursor:not-allowed}
      .btn-group{display:flex;gap:8px;margin-top:1.5rem;justify-content:flex-end}
      .btn{border:1px solid var(--border);background:transparent;color:#e2e8f0;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all .2s ease;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
      .btn:hover:not(:disabled){background:var(--primary);border-color:var(--primary);transform:translateY(-1px)}
      .btn:disabled{opacity:.5;cursor:not-allowed}
      .btn.primary{background-color:var(--primary);border-color:var(--primary)}
      .btn.secondary{background-color:var(--card);border-color:var(--border)}
      .section{margin-top:2.5rem;padding-top:1.5rem;border-top:1px solid var(--border)}
      .section h2{margin-top:0}
      .financial-overview, .document-list, .history-log {margin-top:1rem;}
      .financial-item, .document-item, .history-item {display:flex;justify-content:space-between;padding:10px;border-radius:4px;margin-bottom:8px;}
      .financial-item {background: #1a243a;}
      .financial-item .label {color:var(--muted);}
      .financial-item .value {font-weight: 500;}
      .table{width:100%;border-collapse:collapse;margin-top:1rem}
      .table th, .table td{border:1px solid var(--border);padding:8px 12px;text-align:left}
      .table th{background:var(--bg)}
    </style>
</head>
<body>
    <main id="app-container">
        <h1>Min Side</h1>
        <div id="loading-view" class="loading">
            <p>Laster din informasjon...</p>
        </div>

        <div id="error-view" class="error" style="display: none;">
            <p>Kunne ikke laste din informasjon. Prøv igjen senere.</p>
        </div>

        <div id="user-view" style="display: none;">
            <div class="section">
                <h2>Din kontaktinformasjon</h2>
                <form id="user-info-form">
                    <div class="form-group">
                        <label for="name">Navn (read-only)</label>
                        <!-- Navn er satt som read-only fordi navneendringer ofte krever formell dokumentasjon (f.eks. ved ekteskap)
                             og bør håndteres direkte av styret/forretningsfører, ikke via en enkel digital forespørsel. -->
                        <input type="text" id="name" name="name" disabled title="Navneendringer må behandles manuelt av styret.">
                    </div>
                    <div class="form-group">
                        <label for="email">E-post</label>
                        <input type="email" id="email" name="email" disabled>
                    </div>
                    <div class="form-group">
                        <label for="phone">Telefon</label>
                        <input type="tel" id="phone" name="phone" disabled>
                    </div>

                    <div class="btn-group">
                        <button type="button" id="edit-btn" class="btn">Endre</button>
                        <button type="button" id="cancel-btn" class="btn secondary" style="display:none;">Avbryt</button>
                        <button type="submit" id="save-btn" class="btn primary" style="display:none;">Lagre endringer</button>
                    </div>
                </form>
            </div>

            <div class="section" id="financial-section">
                <h2>Felleskostnader</h2>
                <div id="financial-loading" class="loading">
                    <p>Laster økonomisk oversikt...</p>
                </div>
                <div id="financial-content" style="display: none;">
                    <p>Her er en oversikt over dine felleskostnader. Ta kontakt med forretningsfører ved spørsmål.</p>
                    <div id="financial-overview-container" class="financial-overview">
                        <!-- Data will be injected here by JavaScript -->
                    </div>
                </div>
                <div id="financial-error" class="error" style="display: none;">
                    <p>Kunne ikke laste økonomisk oversikt.</p>
                </div>
            </div>

            <div class="section" id="history-section">
                <h2>Eierskapshistorikk for din seksjon</h2>
                <div id="history-loading" class="loading">
                    <p>Laster eierskapshistorikk...</p>
                </div>
                <div id="history-content" style="display: none;">
                    <!-- History table will be injected here -->
                </div>
                <div id="history-error" class="error" style="display: none;">
                    <p>Kunne ikke laste eierskapshistorikk.</p>
                </div>
            </div>

            <div class="section" id="documents-section">
                <h2>Dine dokumenter</h2>
                <div id="documents-loading" class="loading">
                    <p>Laster dokumenter...</p>
                </div>
                <div id="documents-content" style="display: none;">
                    <!-- Document list will be injected here -->
                </div>
                <div id="documents-error" class="error" style="display: none;">
                    <p>Kunne ikke laste dokumenter.</p>
                </div>
            </div>
        </div>
    </main>

    <script>
      const MinSide = {
        form: null,
        editBtn: null,
        saveBtn: null,
        cancelBtn: null,
        originalData: {},

        init() {
          this.form = document.getElementById('user-info-form');
          this.editBtn = document.getElementById('edit-btn');
          this.saveBtn = document.getElementById('save-btn');
          this.cancelBtn = document.getElementById('cancel-btn');

          this.setupEventListeners();
          this.loadUserInfo();
          this.loadFinancials();
          this.loadOwnershipHistory();
          this.loadSectionDocuments();
        },

        setupEventListeners() {
          this.editBtn.addEventListener('click', () => this.toggleEdit(true));
          this.cancelBtn.addEventListener('click', () => this.cancelEdit());
          this.form.addEventListener('submit', (e) => this.saveChanges(e));
        },

        loadUserInfo() {
          this.showView('loading');
          google.script.run
            .withSuccessHandler(response => {
              if (response.ok && response.data) {
                this.originalData = response.data;
                this.populateForm(response.data);
                this.showView('user');
              } else {
                this.showError(response.message);
              }
            })
            .withFailureHandler(error => this.showError(error.message))
            .getUserInfo();
        },

        loadFinancials() {
          google.script.run
            .withSuccessHandler(response => {
              const loadingEl = document.getElementById('financial-loading');
              const contentEl = document.getElementById('financial-content');
              const errorEl = document.getElementById('financial-error');
              loadingEl.style.display = 'none';

              if (response.ok && response.data) {
                this.renderFinancials(response.data);
                contentEl.style.display = 'block';
              } else {
                errorEl.textContent = 'Feil: ' + (response.message || 'Kunne ikke hente økonomisk data.');
                errorEl.style.display = 'block';
              }
            })
            .withFailureHandler(error => {
              const loadingEl = document.getElementById('financial-loading');
              const errorEl = document.getElementById('financial-error');
              loadingEl.style.display = 'none';
              errorEl.textContent = 'En teknisk feil oppstod: ' + error.message;
              errorEl.style.display = 'block';
            })
            .getFinancials();
        },

        renderFinancials(data) {
          const container = document.getElementById('financial-overview-container');
          container.innerHTML = '';

          const summaryItems = {
            'Månedlige felleskostnader': data.monthly_cost,
            'Neste forfall': data.next_due_date,
            'Status': data.status,
            'Utestående beløp': data.outstanding_amount
          };

          Object.entries(summaryItems).forEach(([label, value]) => {
            if (typeof value !== 'undefined') {
              const item = document.createElement('div');
              item.className = 'financial-item';
              item.innerHTML = `<span class="label">${label}</span><span class="value">${value}</span>`;
              container.appendChild(item);
            }
          });
        },

        loadOwnershipHistory() {
          google.script.run
            .withSuccessHandler(response => {
              const loadingEl = document.getElementById('history-loading');
              const contentEl = document.getElementById('history-content');
              const errorEl = document.getElementById('history-error');
              loadingEl.style.display = 'none';

              if (response.ok && response.data) {
                this.renderOwnershipHistory(response.data);
                contentEl.style.display = 'block';
              } else {
                errorEl.textContent = 'Feil: ' + (response.message || 'Kunne ikke hente historikk.');
                errorEl.style.display = 'block';
              }
            })
            .withFailureHandler(error => {
              const loadingEl = document.getElementById('history-loading');
              const errorEl = document.getElementById('history-error');
              loadingEl.style.display = 'none';
              errorEl.textContent = 'En teknisk feil oppstod: ' + error.message;
              errorEl.style.display = 'block';
            })
            .getOwnershipHistory();
        },

        renderOwnershipHistory(history) {
          const container = document.getElementById('history-content');
          if (!history || history.length === 0) {
            container.innerHTML = '<p>Ingen eierskapshistorikk funnet for din seksjon.</p>';
            return;
          }

          let table = `<table class="table">
              <thead>
                <tr>
                  <th>Fra dato</th>
                  <th>Til dato</th>
                  <th>Eier</th>
                </tr>
              </thead>
              <tbody>`;
          history.forEach(entry => {
            table += `<tr>
                <td>${entry.from_date || ''}</td>
                <td>${entry.to_date || 'Nåværende'}</td>
                <td>${entry.owner_name || ''}</td>
              </tr>`;
          });
          table += `</tbody></table>`;
          container.innerHTML = table;
        },

        loadSectionDocuments() {
          google.script.run
            .withSuccessHandler(response => {
              const loadingEl = document.getElementById('documents-loading');
              const contentEl = document.getElementById('documents-content');
              const errorEl = document.getElementById('documents-error');
              loadingEl.style.display = 'none';

              if (response.ok && response.data) {
                this.renderSectionDocuments(response.data);
                contentEl.style.display = 'block';
              } else {
                errorEl.textContent = 'Feil: ' + (response.message || 'Kunne ikke hente dokumenter.');
                errorEl.style.display = 'block';
              }
            })
            .withFailureHandler(error => {
              const loadingEl = document.getElementById('documents-loading');
              const errorEl = document.getElementById('documents-error');
              loadingEl.style.display = 'none';
              errorEl.textContent = 'En teknisk feil oppstod: ' + error.message;
              errorEl.style.display = 'block';
            })
            .getSectionDocuments();
        },

        renderSectionDocuments(documents) {
          const container = document.getElementById('documents-content');
          if (!documents || documents.length === 0) {
            container.innerHTML = '<p>Ingen seksjonsspesifikke dokumenter funnet.</p>';
            return;
          }

          let list = '<div class="document-list">';
          documents.forEach(doc => {
            list += `<div class="document-item">
                <span>${doc.name}</span>
                <a href="${doc.url}" target="_blank" class="btn">Last ned</a>
              </div>`;
          });
          list += `</div>`;
          container.innerHTML = list;
        },

        populateForm(data) {
          this.form.elements.name.value = data.name || '';
          this.form.elements.email.value = data.email || '';
          this.form.elements.phone.value = data.phone || '';
        },

        toggleEdit(isEditing) {
          this.form.elements.email.disabled = !isEditing;
          this.form.elements.phone.disabled = !isEditing;

          this.editBtn.style.display = isEditing ? 'none' : 'inline-flex';
          this.saveBtn.style.display = isEditing ? 'inline-flex' : 'none';
          this.cancelBtn.style.display = isEditing ? 'inline-flex' : 'none';
        },

        cancelEdit() {
          this.populateForm(this.originalData);
          this.toggleEdit(false);
        },

        saveChanges(event) {
          event.preventDefault();
          this.saveBtn.disabled = true;
          this.saveBtn.textContent = 'Lagrer...';

          const updatedData = {
            email: this.form.elements.email.value,
            phone: this.form.elements.phone.value,
          };

          google.script.run
            .withSuccessHandler(response => {
              this.saveBtn.disabled = false;
              this.saveBtn.textContent = 'Lagre endringer';
              if (response.ok) {
                this.showNotification('Endringsforespørsel er sendt til styret for godkjenning.', 'success');
                this.originalData = { ...this.originalData, ...updatedData };
                this.toggleEdit(false);
              } else {
                this.showNotification('Feil: ' + response.message, 'error');
              }
            })
            .withFailureHandler(error => {
                this.saveBtn.disabled = false;
                this.saveBtn.textContent = 'Lagre endringer';
                this.showNotification('En teknisk feil oppstod: ' + error.message, 'error');
            })
            .updateUserInfo(updatedData);
        },

        showView(viewId) {
            document.getElementById('loading-view').style.display = viewId === 'loading' ? 'block' : 'none';
            document.getElementById('user-view').style.display = viewId === 'user' ? 'block' : 'none';
            document.getElementById('error-view').style.display = viewId === 'error' ? 'block' : 'none';
        },

        showError(message) {
            this.showView('error');
            const errorEl = document.getElementById('error-view');
            errorEl.textContent = `Feil: ${message || 'Ukjent feil'}. Prøv å laste siden på nytt.`;
        },

        showNotification(message, type = 'info') {
          const el = document.createElement('div');
          el.textContent = message;
          el.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'primary'});
            color: #fff;
            padding: 12px 16px;
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,.3);
            transition: opacity 0.3s ease;
          `;
          document.body.appendChild(el);
          setTimeout(() => {
            el.style.opacity = '0';
            setTimeout(() => el.remove(), 300);
          }, 5000);
        }
      };

      document.addEventListener('DOMContentLoaded', () => MinSide.init());
    </script>
</body>
</html>