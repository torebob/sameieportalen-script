<? var FILE = '44_Avtalebehandler.html'; var VERSION = '1.0.0'; var UPDATED = '2025-09-28'; ?>
<?!= include && include('AppMetaPartial') ?>
<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sameieportal — Avtalebehandler</title>
  <style>
    :root{--bg:#0b1220;--card:#0f172a;--muted:#94a3b8;--border:#1f2937;--primary:#3b82f6;--success:#10b981;--danger:#ef4444}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#fff}
    .wrap{max-width:1000px;margin:0 auto;padding:20px}
    .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .title{font-size:22px;font-weight:700}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:14px}
    .card h3{margin:0 0 10px;font-size:16px}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
    .form-group{display:flex;flex-direction:column}
    .form-group label{font-size:13px;color:var(--muted);margin-bottom:4px}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:#0c1526;color:#fff;font-size:14px}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#0b1b33;color:#e2e8f0;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .btn:disabled{cursor:not-allowed;opacity:0.6}
    .table-wrap{overflow-x:auto;max-height:400px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--border)}
    th{font-size:13px;color:var(--muted);background:var(--card)}
    .actions{display:flex;gap:8px}
    .toast{position:fixed;top:20px;right:20px;background:#0b1b33;color:#fff;padding:12px 14px;border:1px solid var(--border);border-radius:10px;z-index:1000;min-width:200px}
    .toast.ok{background:var(--success)}
    .toast.err{background:var(--danger)}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <div class="title">Avtalebehandler</div>
      <div id="status" class="muted">Laster...</div>
    </div>

    <div class="card">
      <h3>Velg leverandør</h3>
      <div class="form-group">
        <label for="leverandorSelect">Leverandør</label>
        <select id="leverandorSelect">
          <option value="">-- Vennligst velg --</option>
        </select>
      </div>
    </div>

    <div id="agreementsSection" class="card hidden">
      <h3>Avtaler for <span id="selectedLeverandorName"></span></h3>
      <div class="table-wrap">
        <table id="agreementsTable">
          <thead>
            <tr>
              <th>Avtalenr.</th>
              <th>Beskrivelse</th>
              <th>Startdato</th>
              <th>Sluttdato</th>
              <th>Handling</th>
            </tr>
          </thead>
          <tbody>
            <!-- Agreement rows will be inserted here -->
          </tbody>
        </table>
      </div>
      <div style="margin-top:14px">
        <button id="btnNyAvtale" class="btn primary">Registrer ny avtale</button>
      </div>
    </div>

    <div id="formSection" class="card hidden">
      <h3 id="formTitle">Registrer ny avtale</h3>
      <form id="agreementForm">
        <input type="hidden" id="AvtaleID" name="AvtaleID">
        <input type="hidden" id="LeverandorID" name="LeverandorID">
        <div class="form-grid">
          <div class="form-group">
            <label for="Avtalenummer">Avtalenummer</label>
            <input type="text" id="Avtalenummer" name="Avtalenummer" required>
          </div>
           <div class="form-group">
            <label for="Startdato">Startdato</label>
            <input type="date" id="Startdato" name="Startdato" required>
          </div>
          <div class="form-group">
            <label for="Sluttdato">Sluttdato</label>
            <input type="date" id="Sluttdato" name="Sluttdato">
          </div>
        </div>
        <div class="form-group" style="margin-top:10px">
          <label for="Tjenestebeskrivelse">Tjenestebeskrivelse</label>
          <textarea id="Tjenestebeskrivelse" name="Tjenestebeskrivelse" rows="3"></textarea>
        </div>
        <div style="margin-top:14px; display:flex; justify-content:flex-end; gap:10px">
          <button type="button" id="btnCancel" class="btn">Avbryt</button>
          <button type="submit" id="btnSave" class="btn primary">Lagre avtale</button>
        </div>
      </form>
    </div>

  </div>

  <script>
    const leverandorSelect = document.getElementById('leverandorSelect');
    const agreementsSection = document.getElementById('agreementsSection');
    const agreementsTableBody = document.querySelector('#agreementsTable tbody');
    const formSection = document.getElementById('formSection');
    const agreementForm = document.getElementById('agreementForm');
    const statusEl = document.getElementById('status');
    let suppliers = [];
    let agreements = [];

    function toast(msg, kind){
      const t=document.createElement('div'); t.className='toast ' + (kind||'');
      t.textContent=String(msg||''); document.body.appendChild(t);
      setTimeout(()=>t.remove(), 2800);
    }

    function setLoading(isLoading, message) {
      statusEl.textContent = message || (isLoading ? 'Laster...' : 'Ferdig');
      document.querySelectorAll('button, select').forEach(el => el.disabled = isLoading);
    }

    function renderSuppliers(res) {
      if (!res || !res.ok) {
        toast(res.message || 'Kunne ikke hente leverandører.', 'err');
        return;
      }
      suppliers = res.suppliers;
      leverandorSelect.innerHTML = '<option value="">-- Vennligst velg --</option>';
      suppliers.forEach(s => {
        const option = document.createElement('option');
        option.value = s.ID;
        option.textContent = s.Navn;
        leverandorSelect.appendChild(option);
      });
    }

    function renderAgreements(res) {
      agreementsTableBody.innerHTML = '';
      if (!res || !res.ok) {
        toast(res.message || 'Kunne ikke hente avtaler.', 'err');
        return;
      }
      agreements = res.agreements;
      if (agreements.length === 0) {
        agreementsTableBody.innerHTML = '<tr><td colspan="5">Ingen avtaler registrert for denne leverandøren.</td></tr>';
        return;
      }
      agreements.forEach(a => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${a.Avtalenummer || ''}</td>
          <td>${a.Tjenestebeskrivelse || ''}</td>
          <td>${a.Startdato ? new Date(a.Startdato).toLocaleDateString() : ''}</td>
          <td>${a.Sluttdato ? new Date(a.Sluttdato).toLocaleDateString() : ''}</td>
          <td class="actions">
            <button class="btn" onclick="editAgreement('${a.AvtaleID}')">Endre</button>
          </td>
        `;
        agreementsTableBody.appendChild(row);
      });
    }

    function fetchAgreements(leverandorId) {
      setLoading(true, 'Henter avtaler...');
      google.script.run
        .withSuccessHandler(res => {
          setLoading(false);
          renderAgreements(res);
          agreementsSection.classList.remove('hidden');
        })
        .withFailureHandler(err => {
          setLoading(false);
          toast(err.message, 'err');
        })
        .avtaleGetAvtaler(leverandorId);
    }

    function showForm(agreement) {
        agreementForm.reset();
        document.getElementById('AvtaleID').value = agreement ? agreement.AvtaleID : '';
        document.getElementById('LeverandorID').value = agreement ? agreement.LeverandorID : leverandorSelect.value;
        document.getElementById('Avtalenummer').value = agreement ? agreement.Avtalenummer : '';
        document.getElementById('Tjenestebeskrivelse').value = agreement ? agreement.Tjenestebeskrivelse : '';
        // Dates need special handling for yyyy-mm-dd format
        document.getElementById('Startdato').value = agreement && agreement.Startdato ? new Date(agreement.Startdato).toISOString().split('T')[0] : '';
        document.getElementById('Sluttdato').value = agreement && agreement.Sluttdato ? new Date(agreement.Sluttdato).toISOString().split('T')[0] : '';

        document.getElementById('formTitle').textContent = agreement ? 'Endre avtale' : 'Registrer ny avtale';
        formSection.classList.remove('hidden');
    }

    window.editAgreement = (avtaleId) => {
        const agreement = agreements.find(a => a.AvtaleID === avtaleId);
        if (agreement) {
            showForm(agreement);
        }
    };

    leverandorSelect.addEventListener('change', () => {
      const selectedId = leverandorSelect.value;
      formSection.classList.add('hidden');
      if (selectedId) {
        const supplier = suppliers.find(s => s.ID == selectedId);
        document.getElementById('selectedLeverandorName').textContent = supplier.Navn;
        fetchAgreements(selectedId);
      } else {
        agreementsSection.classList.add('hidden');
      }
    });

    document.getElementById('btnNyAvtale').addEventListener('click', () => {
        showForm(null);
    });

    document.getElementById('btnCancel').addEventListener('click', () => {
        formSection.classList.add('hidden');
    });

    agreementForm.addEventListener('submit', (e) => {
      e.preventDefault();
      setLoading(true, 'Lagrer...');
      const formData = new FormData(agreementForm);
      const payload = Object.fromEntries(formData.entries());

      google.script.run
        .withSuccessHandler(res => {
          setLoading(false);
          if (res.ok) {
            toast('Avtale lagret!', 'ok');
            formSection.classList.add('hidden');
            fetchAgreements(payload.LeverandorID);
          } else {
            toast(res.message, 'err');
          }
        })
        .withFailureHandler(err => {
          setLoading(false);
          toast(err.message, 'err');
        })
        .avtaleLagre(payload);
    });

    function init() {
      setLoading(true, 'Henter leverandører...');
      google.script.run
        .withSuccessHandler(res => {
          setLoading(false);
          renderSuppliers(res);
        })
        .withFailureHandler(err => {
          setLoading(false);
          toast(err.message, 'err');
        })
        .avtaleGetLeverandorer();
    }

    init();
  </script>
</body>
</html>