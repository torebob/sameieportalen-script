<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Leverandørprofil</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { max-width: 800px; margin: auto; }
    .header { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
    .details-grid { display: grid; grid-template-columns: 150px 1fr; gap: 10px; }
    .upload-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ccc; }
    #status { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 id="vendor-name">Laster leverandør...</h1>
    </div>

    <div class="details-grid">
      <strong>Kategori:</strong> <span id="vendor-kategori"></span>
      <strong>Komponent:</strong> <span id="vendor-komponent"></span>
      <strong>Telefon:</strong> <span id="vendor-telefon"></span>
      <strong>Epost:</strong> <span id="vendor-epost"></span>
      <strong>Notat:</strong> <span id="vendor-notat"></span>
      <strong>Avtale:</strong> <span id="vendor-avtale-link"></span>
    </div>

    <div class="upload-section">
      <h2>Last opp ny avtale</h2>
      <form id="upload-form">
        <input type="file" id="file-input" name="avtale" required>
        <button type="submit">Last opp</button>
      </form>
      <div id="status"></div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const vendorId = urlParams.get('id');

      if (vendorId) {
        google.script.run
          .withSuccessHandler(displayVendorDetails)
          .withFailureHandler(showError)
          .getLeverandorDetails(vendorId);
      } else {
        showError('Ingen leverandør-ID funnet.');
      }

      document.getElementById('upload-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const file = document.getElementById('file-input').files[0];
        if (!file) {
          showError('Vennligst velg en fil.');
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          const fileData = {
            fileName: file.name,
            mimeType: file.type,
            content: e.target.result.split(',')[1] // Base64 content
          };

          document.getElementById('status').textContent = 'Laster opp...';
          google.script.run
            .withSuccessHandler(uploadSuccess)
            .withFailureHandler(showError)
            .uploadAvtaleDokument(vendorId, fileData);
        };
        reader.readAsDataURL(file);
      });
    });

    function displayVendorDetails(vendor) {
      document.getElementById('vendor-name').textContent = vendor.Navn;
      document.getElementById('vendor-kategori').textContent = vendor.Kategori;
      document.getElementById('vendor-komponent').textContent = vendor.Komponent;
      document.getElementById('vendor-telefon').textContent = vendor.Telefon;
      document.getElementById('vendor-epost').textContent = vendor.Epost;
      document.getElementById('vendor-notat').textContent = vendor.Notat;

      const avtaleLink = document.getElementById('vendor-avtale-link');
      if (vendor.AvtaleURL) {
        avtaleLink.innerHTML = `<a href="${vendor.AvtaleURL}" target="_blank">Se avtale</a>`;
      } else {
        avtaleLink.textContent = 'Ingen avtale lastet opp.';
      }
    }

    function uploadSuccess(newUrl) {
      document.getElementById('status').textContent = 'Opplasting vellykket!';
      const avtaleLink = document.getElementById('vendor-avtale-link');
      avtaleLink.innerHTML = `<a href="${newUrl}" target="_blank">Se ny avtale</a>`;
      document.getElementById('file-input').value = ''; // Clear input
    }

    function showError(error) {
      document.getElementById('status').textContent = 'Feil: ' + error.message;
    }
  </script>
</body>
</html>