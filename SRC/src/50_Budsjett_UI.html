<!-- ====================== Budsjett – UI (Dashboard App) ======================
     FILE: 50_Budsjett_UI.html | VERSION: 1.0.0 | UPDATED: 2025-09-15
     FORMÅL: Lettvekts UI for budsjettering. Leser/lagrer via 52_Budsjett_API.
     RBAC: Leder/Kasserer kan redigere; andre leser.
============================================================================= -->
<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Budsjett</title>
<style>
  :root { --bg:#f8fafc; --card:#fff; --muted:#6b7280; --line:#e5e7eb; --accent:#2563eb; --danger:#dc2626; --ok:#16a34a; }
  *{ box-sizing:border-box } body{ margin:0; background:var(--bg); font:14px/1.4 system-ui, Segoe UI, Arial }
  .wrap{ max-width:1100px; margin:24px auto; padding:0 16px }
  .bar{ display:flex; gap:12px; align-items:center; background:var(--card); border:1px solid var(--line); padding:12px; border-radius:12px }
  h2{ margin:0 8px 0 0; font-size:18px }
  .role{ margin-left:auto; font-size:12px; color:#0f172a; background:#e2e8f0; padding:4px 8px; border-radius:999px }
  .input, select{ border:1px solid var(--line); border-radius:8px; padding:8px 10px; background:#fff; min-width:100px }
  .btn{ border:1px solid var(--line); background:#fff; border-radius:8px; padding:8px 12px; cursor:pointer }
  .btn.primary{ background:var(--accent); border-color:var(--accent); color:#fff }
  .btn.ghost{ background:transparent }
  .btn[disabled]{ opacity:.5; cursor:not-allowed }
  .grid-card, .sum-card{ background:var(--card); border:1px solid var(--line); border-radius:12px; margin-top:14px; overflow:hidden }
  .toolbar{ display:flex; gap:8px; align-items:center; padding:10px; border-bottom:1px solid var(--line); background:#f9fafb }
  table{ width:100%; border-collapse:collapse; font-size:13px }
  th, td{ border-top:1px solid var(--line); padding:8px }
  th{ text-align:left; background:#f8fafc }
  td input, td select{ width:100%; padding:6px 8px; border:1px solid var(--line); border-radius:6px; background:#fff }
  .right{ text-align:right }
  .muted{ color:var(--muted) }
  .msg{ margin-top:10px; font-size:13px }
  .msg.ok{ color:var(--ok) } .msg.err{ color:var(--danger) }
  .chips{ display:flex; gap:6px; flex-wrap:wrap }
  .chip{ background:#eef2ff; color:#3730a3; border:1px solid #e0e7ff; padding:2px 8px; border-radius:999px; font-size:12px }
  .spinner{ display:none; margin-left:8px }
  .spinner.show{ display:inline-block; width:16px; height:16px; border:2px solid #93c5fd; border-top-color:transparent; border-radius:50%; animation:spin .8s linear infinite }
  @keyframes spin{ to{ transform:rotate(360deg) } }
  .badge{ font-size:11px; padding:2px 6px; border-radius:6px; border:1px solid var(--line); background:#fafafa }
  .danger{ color:var(--danger) }
  tfoot td{ background:#fcfcfc; font-weight:600; }
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <h2>💼 Budsjett</h2>
    <label>År <input id="year" class="input" type="number" value="" min="2000" max="2100"></label>
    <label>Versjon <input id="version" class="input" type="text" value="main"></label>
    <button id="btnLoad" class="btn">Last</button>
    <button id="btnSave" class="btn primary">Lagre (erstatt år+versjon)</button>
    <div class="spinner" id="spin"></div>
    <span id="roleBadge" class="role">…</span>
  </div>

  <div class="grid-card">
    <div class="toolbar">
      <strong>Linjer</strong>
      <span class="muted" id="countLbl">0 linjer</span>
      <div class="chips" id="monthChips"></div>
      <button id="btnAdd" class="btn">+ Ny linje</button>
      <button id="btnExport" class="btn ghost">Eksporter CSV</button>
      <span class="muted" style="margin-left:auto">Felter: Konto, Navn, Mnd, Beløp, MVA, Kommentar</span>
    </div>
    <table id="grid">
      <thead>
        <tr>
          <th style="width:100px">Konto</th>
          <th>Navn</th>
          <th style="width:110px">Måned</th>
          <th style="width:130px" class="right">Beløp</th>
          <th style="width:90px">MVA</th>
          <th>Kommentar</th>
          <th style="width:44px"></th>
        </tr>
      </thead>
      <tbody id="gridBody"></tbody>
      <tfoot>
        <tr>
          <td colspan="3" class="right">Sum</td>
          <td class="right" id="sumCell">0</td>
          <td colspan="3"></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="sum-card">
    <div class="toolbar">
      <strong>Oppsummering pr. konto (inkl. MVA)</strong>
      <span class="muted" id="sumHint"></span>
    </div>
    <table id="sumTable">
      <thead>
        <tr>
          <th style="width:100px">Konto</th>
          <th>Navn</th>
          <th class="right">Sum</th>
          <th>Jan</th><th>Feb</th><th>Mar</th><th>Apr</th><th>Mai</th><th>Jun</th>
          <th>Jul</th><th>Aug</th><th>Sep</th><th>Okt</th><th>Nov</th><th>Des</th>
        </tr>
      </thead>
      <tbody id="sumBody"></tbody>
    </table>
  </div>

  <div id="msg" class="msg muted"></div>
</div>

<script>
(() => {
  const el = (id) => document.getElementById(id);
  const months = ['Jan','Feb','Mar','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Des'];
  let schema = null;
  let profile = null;
  let rows = []; // {account,name,month,amount,vat,comment}

  function setBusy(b){ el('spin').classList.toggle('show', !!b); }
  function m(n){ return new Intl.NumberFormat('no-NO',{maximumFractionDigits:0}).format(n||0); }
  function toNumber(v){
    if (v === '' || v == null) return 0;
    let s = String(v).replace(/\s/g,'').replace(/\./g,'').replace(',','.');
    const n = Number(s); return isFinite(n) ? n : 0;
  }
  function canEdit(){ return profile && profile.canEdit === true; }
  function setEditMode(enabled){
    el('btnSave').disabled = !enabled;
    el('btnAdd').disabled = !enabled;
    // Disable inputs inside grid when read-only
    document.querySelectorAll('#gridBody input, #gridBody select').forEach(inp => inp.disabled = !enabled);
  }

  function badge(text){ el('roleBadge').textContent = text; }

  function monthSelectHtml(value){
    const opts = months.map(mo => `<option value="${mo}" ${mo===value?'selected':''}>${mo}</option>`).join('');
    return `<select>${opts}</select>`;
  }

  function rowHtml(r, idx){
    return `<tr data-i="${idx}">
      <td><input value="${r.account||''}" placeholder="3000"></td>
      <td><input value="${r.name||''}" placeholder="Tekst…"></td>
      <td>${monthSelectHtml(r.month||'')}</td>
      <td class="right"><input value="${r.amount!=null?r.amount:''}" placeholder="0" style="text-align:right"></td>
      <td><input value="${r.vat||''}" placeholder="0/25"></td>
      <td><input value="${r.comment||''}" placeholder=""></td>
      <td class="right"><button class="btn ghost danger" title="Slett" data-del="1">✕</button></td>
    </tr>`;
  }

  function render(){
    el('gridBody').innerHTML = rows.map((r,i)=>rowHtml(r,i)).join('') || `<tr><td colspan="7" class="muted">Ingen linjer.</td></tr>`;
    // Sum
    const total = rows.reduce((s,r)=> s + toNumber(r.amount) * (String(r.vat||'').trim()==='25' ? 1.25 : 1), 0);
    el('sumCell').textContent = m(total);
    // Info
    el('countLbl').textContent = `${rows.length} linjer`;
    // Month chips
    const used = [...new Set(rows.map(r=>r.month).filter(Boolean))];
    el('monthChips').innerHTML = used.map(x=>`<span class="chip">${x}</span>`).join('');
    // Readonly?
    setEditMode(canEdit());
  }

  function readGridIntoRows(){
    const out = [];
    document.querySelectorAll('#gridBody tr').forEach(tr => {
      const tds = tr.querySelectorAll('td');
      const account = tds[0].querySelector('input').value.trim();
      const name    = tds[1].querySelector('input').value.trim();
      const month   = tds[2].querySelector('select').value;
      const amount  = toNumber(tds[3].querySelector('input').value);
      const vat     = tds[4].querySelector('input').value.trim();
      const comment = tds[5].querySelector('input').value.trim();
      if (account || name || amount || comment) {
        out.push({ account, name, month, amount, vat, comment });
      }
    });
    rows = out;
  }

  function msg(text, kind){
    const box = el('msg');
    box.textContent = text || '';
    box.className = `msg ${kind||'muted'}`;
  }

  function loadBudget(){
    const year = Number(el('year').value);
    const version = el('version').value.trim() || 'main';
    if (!year) { msg('Oppgi år.', 'err'); return; }
    setBusy(true); msg('Laster …');
    google.script.run
      .withSuccessHandler(res => {
        setBusy(false);
        if (!res || !res.ok){ msg(res && res.error ? res.error : 'Kunne ikke laste.', 'err'); return; }
        rows = (res.items||[]).map(x => ({
          account:x.account, name:x.name, month:x.month, amount:x.amount, vat:x.vat, comment:x.comment
        }));
        render(); msg(`Lastet ${rows.length} linjer for ${year}/${version}.`, 'ok');
        refreshSummary(year, version);
      })
      .withFailureHandler(e => { setBusy(false); msg(String(e && e.message || e), 'err'); })
      .getBudget(year, version);
  }

  function refreshSummary(year, version){
    el('sumBody').innerHTML = `<tr><td colspan="15" class="muted">Beregner …</td></tr>`;
    google.script.run
      .withSuccessHandler(res => {
        if (!res || !res.ok){ el('sumBody').innerHTML = `<tr><td colspan="15" class="danger">${res && res.error || 'Feil ved beregning.'}</td></tr>`; return; }
        const body = (res.rows||[]).map(r => {
          return `<tr>
            <td>${r.account||''}</td>
            <td>${r.name||''}</td>
            <td class="right">${m(r.sum||0)}</td>
            ${months.map(mo => `<td class="right">${m(r[mo]||0)}</td>`).join('')}
          </tr>`;
        }).join('') || `<tr><td colspan="15" class="muted">Ingen summer.</td></tr>`;
        el('sumBody').innerHTML = body;
        el('sumHint').textContent = `År ${year}, versjon “${version}”`;
      })
      .withFailureHandler(e => {
        el('sumBody').innerHTML = `<tr><td colspan="15" class="danger">${String(e && e.message || e)}</td></tr>`;
      })
      .calculateBudgetSummary(year, version);
  }

  function saveReplace(){
    if (!canEdit()){ msg('Du har ikke redigeringstilgang.', 'err'); return; }
    readGridIntoRows();
    const year = Number(el('year').value);
    const version = el('version').value.trim() || 'main';
    if (!year){ msg('Oppgi år før lagring.', 'err'); return; }
    // Normaliser til API-format
    const lines = rows.map(r => ({
      year, version,
      account:r.account||'', name:r.name||'', month:r.month||'',
      amount: toNumber(r.amount), vat: (r.vat||'').trim(),
      comment: r.comment||''
    }));
    setBusy(true); msg('Lagrer …');
    google.script.run
      .withSuccessHandler(res => {
        setBusy(false);
        if (!res || !res.ok){ msg(res && res.error ? res.error : 'Klarte ikke å lagre.', 'err'); return; }
        msg(`Lagret ${res.appended||lines.length} linjer (erstattet eksisterende for ${year}/${version}).`, 'ok');
        loadBudget();
      })
      .withFailureHandler(e => { setBusy(false); msg(String(e && e.message || e), 'err'); })
      .replaceBudget(year, version, lines);
  }

  function exportCsv(){
    readGridIntoRows();
    const year = Number(el('year').value||0);
    const version = el('version').value.trim()||'main';
    const header = ['År','Versjon','Konto','Navn','Måned','Beløp','MVA','Kommentar'];
    const lines = rows.map(r => [year,version,r.account||'',r.name||'',r.month||'',toNumber(r.amount), (r.vat||''), (r.comment||'')]);
    const csv = [header].concat(lines).map(a => a.map(x => {
      const s = String(x==null?'':x);
      return /[",;\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(';')).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download=`budsjett_${year}_${version}.csv`; a.click();
    URL.revokeObjectURL(url);
  }

  // --- Events ---
  document.addEventListener('click', (ev) => {
    const t = ev.target;
    if (t.id === 'btnLoad') loadBudget();
    if (t.id === 'btnSave') saveReplace();
    if (t.id === 'btnAdd'){
      rows.push({ account:'', name:'', month: months[new Date().getMonth()] || 'Jan', amount:0, vat:'', comment:'' });
      render();
    }
    if (t.id === 'btnExport') exportCsv();
    if (t.dataset && t.dataset.del){
      const tr = t.closest('tr'); const idx = Number(tr.dataset.i); rows.splice(idx,1); render();
    }
  });

  document.addEventListener('change', (ev) => {
    const tr = ev.target.closest('tr'); if (!tr) return;
    const i = Number(tr.dataset.i||-1); if (i<0) return;
    const tds = tr.querySelectorAll('td');
    rows[i] = {
      account: tds[0].querySelector('input').value.trim(),
      name:    tds[1].querySelector('input').value.trim(),
      month:   tds[2].querySelector('select').value,
      amount:  toNumber(tds[3].querySelector('input').value),
      vat:     tds[4].querySelector('input').value.trim(),
      comment: tds[5].querySelector('input').value.trim()
    };
    render();
  });

  // --- Init ---
  (function init(){
    // År default = inneværende
    const now = new Date(); el('year').value = now.getFullYear();
    setBusy(true); msg('Starter …');
    google.script.run
      .withSuccessHandler(sc => {
        schema = sc || {};
        google.script.run
          .withSuccessHandler(p => {
            profile = p || { canEdit:false, role:'LESER' };
            badge(`${p.role || 'UKJENT'} ${p.canEdit?'(rediger)':'(les)'}`);
            // Lesetilgang skrur av Save/+knapp automatisk i render()
            render();
            msg('Klar.');
            setBusy(false);
          })
          .withFailureHandler(e => { setBusy(false); msg(String(e && e.message || e), 'err'); })
          .getCurrentUserProfile();
      })
      .withFailureHandler(e => { setBusy(false); msg(String(e && e.message || e), 'err'); })
      .getBudgetSchema();
  })();
})();
</script>
</body>
</html>
