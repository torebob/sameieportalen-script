<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="utf-8">
    <title>Del Dokument</title>
    <base target="_top">
    <style>
      :root{--bg:#0b1220;--card:#0f172a;--muted:#94a3b8;--border:#1f2937;--primary:#3b82f6;--success:#10b981;--danger:#ef4444}
      body{margin:0;padding:24px;font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,system-ui,sans-serif;background:var(--bg);color:#fff;line-height:1.5}
      h1 { margin-top: 0; }
      #loader { text-align: center; padding: 40px; }
      #error { color: var(--danger); }
      .filter-container { margin-bottom: 16px; display: flex; align-items: center; gap: 12px; }
      #category-filter {
        background: var(--card);
        color: #fff;
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 14px;
      }
      .doc-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
      .doc-table th, .doc-table td { border: 1px solid var(--border); padding: 10px; text-align: left; font-size: 14px; }
      .doc-table th { background: var(--bg); }
      .btn{border:1px solid var(--border);background:var(--card);color:#e2e8f0;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;transition:all .2s ease;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
      .btn:hover:not(:disabled){background:var(--primary);border-color:var(--primary);transform:translateY(-1px)}
      .btn:disabled{opacity:.5;cursor:not-allowed}
      .btn.share-btn { background-color: var(--success); border-color: var(--success); }
    </style>
</head>
<body>
    <h1>Del Dokument med Beboere</h1>
    <p>Velg et dokument fra listen under for å dele det som et nytt oppslag til alle beboere.</p>

    <div id="loader">Laster dokumenter...</div>
    <div id="error" style="display:none;"></div>
    <div id="content" style="display:none;">
        <div class="filter-container">
            <label for="category-filter">Filtrer på kategori:</label>
            <select id="category-filter"></select>
        </div>
        <table class="doc-table">
            <thead>
                <tr>
                    <th>Dokumentnavn</th>
                    <th>Kategori</th>
                    <th>Handling</th>
                </tr>
            </thead>
            <tbody id="doc-list"></tbody>
        </table>
    </div>

    <script>
      const ShareApp = {
        documents: [],
        loader: document.getElementById('loader'),
        errorEl: document.getElementById('error'),
        contentEl: document.getElementById('content'),
        docListEl: document.getElementById('doc-list'),
        categoryFilterEl: document.getElementById('category-filter'),

        init() {
          this.categoryFilterEl.addEventListener('change', () => this.renderList());
          google.script.run
            .withSuccessHandler(docs => {
              this.documents = docs;
              this.populateCategoryFilter();
              this.renderList();
              this.showContent();
            })
            .withFailureHandler(err => this.showError(err.message))
            .getShareableDocuments();
        },

        populateCategoryFilter() {
          const categories = ['Alle', ...new Set(this.documents.map(d => d.kategori))];
          this.categoryFilterEl.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
        },

        renderList() {
          const selectedCategory = this.categoryFilterEl.value;
          const filteredDocs = selectedCategory === 'Alle'
            ? this.documents
            : this.documents.filter(d => d.kategori === selectedCategory);

          if (filteredDocs.length === 0) {
            this.docListEl.innerHTML = '<tr><td colspan="3" style="text-align:center;">Ingen dokumenter funnet. Fyll ut "Vedlegg"-arket.</td></tr>';
            return;
          }

          this.docListEl.innerHTML = filteredDocs.map(doc => `
            <tr>
              <td>${this.escapeHtml(doc.navn)}</td>
              <td>${this.escapeHtml(doc.kategori)}</td>
              <td>
                <button class="btn share-btn" onclick="ShareApp.handleShare(this, '${btoa(JSON.stringify(doc))}')">
                  Del med Beboere
                </button>
              </td>
            </tr>
          `).join('');
        },

        handleShare(button, docData) {
          const doc = JSON.parse(atob(docData));
          if (!confirm(`Er du sikker på at du vil dele "${doc.navn}" med alle beboere?`)) return;

          button.disabled = true;
          button.textContent = 'Sender...';

          google.script.run
            .withSuccessHandler(response => {
              if (response.ok) {
                this.showNotification('Dokumentet ble delt!', 'success');
                // Lukk modalen etter vellykket deling
                setTimeout(() => google.script.host.close(), 1500);
              } else {
                this.showError('En feil oppsto ved deling: ' + response.message);
                button.disabled = false;
                button.textContent = 'Del med Beboere';
              }
            })
            .withFailureHandler(err => {
              this.showError(err.message);
              button.disabled = false;
              button.textContent = 'Del med Beboere';
            })
            .shareDocumentWithResidents(doc);
        },

        showContent() {
          this.loader.style.display = 'none';
          this.contentEl.style.display = 'block';
        },

        showError(message) {
          this.loader.style.display = 'none';
          this.errorEl.textContent = `Feil: ${message}`;
          this.errorEl.style.display = 'block';
        },

        escapeHtml(str) {
            return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        },

        showNotification(message, type = 'info') {
          const el = document.createElement('div');
          el.textContent = message;
          el.style.cssText = `
            position: fixed; top: 20px; right: 20px;
            background: var(--${type === 'success' ? 'success' : 'danger'});
            color: #fff; padding: 12px 16px; border-radius: 8px;
            z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,.3);
          `;
          document.body.appendChild(el);
          setTimeout(() => el.remove(), 3000);
        }
      };

      document.addEventListener('DOMContentLoaded', () => ShareApp.init());
    </script>
</body>
</html>