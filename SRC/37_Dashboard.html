<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="utf-8">
    <title><?= appName ?> Dashboard</title>
    <base target="_top">
    <style>
      :root{--bg:#0b1220;--card:#0f172a;--muted:#94a3b8;--border:#1f2937;--primary:#3b82f6;--success:#10b981;--warning:#f59e0b;--danger:#ef4444}
      *{box-sizing:border-box}
      body{margin:0;padding:12px;font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,system-ui,sans-serif;background:var(--bg);color:#fff;line-height:1.5}
      header, main {max-width: 800px; margin: 0 auto;}
      .btn{border:1px solid var(--border);background:var(--card);color:#e2e8f0;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;transition:all .2s ease;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
      .btn:hover:not(:disabled){background:var(--primary);border-color:var(--primary);transform:translateY(-1px)}
      .btn:disabled{opacity:.5;cursor:not-allowed}
      .btn.success{background-color: var(--success); border-color: var(--success);}
      .badge{font-size:12px;color:var(--muted)}
      .btn-group{display:flex;flex-wrap:wrap;gap:8px; margin-top: 1rem;}
      h1 { border-bottom: 1px solid var(--border); padding-bottom: 8px; }
      .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:1001;opacity:0;visibility:hidden;transition:opacity .3s ease}
      .modal.visible{opacity:1;visibility:visible}
      .modal-content{background:var(--card);padding:24px;border-radius:8px;width:90%;max-width:700px;max-height:80vh;overflow-y:auto;box-shadow:0 10px 25px rgba(0,0,0,.5)}
      .modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);padding-bottom:12px;margin-bottom:16px}
      .modal-title{margin:0;font-size:18px}
      .modal-close{background:0 0;border:0;color:#fff;font-size:24px;cursor:pointer;padding:0}
      .risk-table{width:100%;border-collapse:collapse;margin-top:16px}
      .risk-table th, .risk-table td{border:1px solid var(--border);padding:8px;text-align:left;font-size:14px}
      .risk-table th{background:var(--bg)}
    </style>
</head>
<body>
    <header>
        <h1>Dashboard</h1>
    </header>
    <main>
        <p>Innlogget som: <b><?= userInfo.email || 'Ukjent' ?></b></p>

        <? if (isAdmin) { ?>
            <div class="btn-group">
                <? if (adminButtons && adminButtons.length > 0) { ?>
                    <? adminButtons.forEach(button => { ?>
                        <button class="btn admin-btn <?= button.class || '' ?>" data-action="<?= button.action ?>">
                            <?= button.label ?>
                        </button>
                    <? }) ?>
                <? } ?>
                <button class="btn admin-btn" data-action="runRiskAnalysis">Start Risikoanalyse</button>
            </div>
        <? } else { ?>
            <span class="badge">Ingen admin-tilgang.</span>
        <? } ?>

        <div id="risk-analysis-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Resultater fra Risikoanalyse</h2>
                    <button class="modal-close" onclick="Dashboard.hideModal()">&times;</button>
                </div>
                <div id="risk-analysis-summary"></div>
                <div id="risk-analysis-results"></div>
            </div>
        </div>
    </main>

    <script>
      const Dashboard = {
        modal: null,

        init() {
          this.modal = document.getElementById('risk-analysis-modal');
          this.setupEventListeners();
        },

        setupEventListeners() {
          document.querySelectorAll('.admin-btn').forEach(btn => {
            btn.addEventListener('click', e => this.handleAdminAction(e.currentTarget.dataset.action, e.currentTarget));
          });
        },

        handleAdminAction(action, button) {
          if (!action || button.disabled) return;

          const originalText = button.textContent;
          button.disabled = true;
          button.textContent = 'Arbeider...';

          const runner = google.script.run
            .withFailureHandler(error => {
              button.disabled = false;
              button.textContent = originalText;
              this.showNotification('Feil: ' + (error?.message || error), 'error');
              console.error(error);
            });

          if (action === 'runRiskAnalysis') {
            runner
              .withSuccessHandler(response => {
                button.disabled = false;
                button.textContent = originalText;
                if (response.ok) {
                  this.displayRiskAnalysisResults(response.results);
                } else {
                  this.showNotification('Analyse feilet: ' + (response.message || 'Ukjent feil'), 'error');
                }
              })
              .runRiskAnalysis();
          } else {
            runner
              .withSuccessHandler(msg => {
                button.disabled = false;
                button.textContent = originalText;
                this.showNotification(msg || 'Utført!', 'success');
              })[action]();
          }
        },

        displayRiskAnalysisResults(results) {
          const summaryEl = document.getElementById('risk-analysis-summary');
          const resultsEl = document.getElementById('risk-analysis-results');

          summaryEl.textContent = results.summary || 'Ingen oppsummering.';

          if (results.identifiedRisks && results.identifiedRisks.length > 0) {
            let table = `<table class="risk-table">
              <thead>
                <tr>
                  <th>Kategori</th>
                  <th>Nøkkelord</th>
                  <th>Kilde</th>
                  <th>Referanse</th>
                  <th>Utdrag</th>
                </tr>
              </thead>
              <tbody>`;
            results.identifiedRisks.forEach(risk => {
              table += `<tr>
                <td>${risk.category || ''}</td>
                <td>${risk.keyword || ''}</td>
                <td>${risk.source || ''}</td>
                <td>${risk.reference || ''}</td>
                <td>${risk.text || ''}</td>
              </tr>`;
            });
            table += `</tbody></table>`;
            resultsEl.innerHTML = table;
          } else {
            resultsEl.innerHTML = '<p>Ingen konkrete risikoer ble identifisert.</p>';
          }

          this.showModal();
        },

        showModal() {
          if (this.modal) this.modal.classList.add('visible');
        },

        hideModal() {
          if (this.modal) this.modal.classList.remove('visible');
        },

        showNotification(message, type = 'info') {
          const el = document.createElement('div');
          el.textContent = message;
          el.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'primary'});
            color: #fff;
            padding: 12px 16px;
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,.3);
            transition: opacity 0.3s ease;
          `;
          document.body.appendChild(el);
          setTimeout(() => {
            el.style.opacity = '0';
            setTimeout(() => el.remove(), 300);
          }, 3000);
        }
      };
      document.addEventListener('DOMContentLoaded', () => Dashboard.init());
    </script>
</body>
</html>