<!doctype html>
<html lang="no">
<head>
  <? 
    // ---------- Versjonskontroll (synkron med øvrige filer) ----------
    var FILE    = '30_Moteoversikt.html';
    var VERSION = '1.6.1';
    var UPDATED = '2025-09-14';
    var PURPOSE = 'Planlegging av møter, agenda, lås/ulås og flytting av saker';
  ?>
  <?!= (typeof include === 'function' && include('AppMetaPartial')) || '' ?>

  <!-- ======================= Møteoversikt & Protokoller (Modal) =======================
       FILE: <?= FILE ?> | VERSION: <?= VERSION ?> | UPDATED: <?= UPDATED ?>

       PURPOSE: <?= PURPOSE ?>

       RBAC:
         - "Lås opp"-knapp vises kun dersom hasPermission('MEETING_UNLOCK') == true
       LÅSE-REGLER:
         - UI låses når møte.status ∈ ['Protokoll under godkjenning','Protokoll godkjent','Arkivert']
       BACKEND (forventet):
         - uiBootstrap() → { user: { email } }
         - listMeetings_({scope}) → [{id,type,dato,start,slutt,sted,tittel,status}]
         - upsertMeeting(form) → {ok,id,message}
         - newAgendaItem(moteId) → {ok,sakId,saksnr}
         - saveAgenda(payload) → {ok}
         - appendInnspill(sakId, text) → {ok}
         - listAgenda(moteId) → [{sakId,saksnr,tittel,forslag,vedtak}]
         - (valgfritt) listInnspill(sakId) → [{sakId,ts,from,text}]
         - (ny) unlockMeeting(moteId) → {ok,status}
         - (ny) moveAgendaToMeeting(sakId, toMoteId) → {ok}
         - (ny) getProtocolPreviewUrl(moteId) -> {url}
         - (valgfritt sanntid) rtServerNow(), rtGetChanges(moteId, sinceIso)
  ====================================================================================== -->

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Møteoversikt & Protokoller</title>
  <link rel="stylesheet" href="styles/moteoversikt.css">
  <link rel="stylesheet" href="SRC/calendar.css">
  <style>
    .task-link-container {
        margin-top: 12px;
        padding: 10px;
        background-color: #f0f8ff; /* AliceBlue */
        border: 1px solid #d4e8ff;
        border-radius: 6px;
        display: none; /* Skjult som standard */
    }
    .task-link-container.visible {
        display: block;
    }
    .task-link-container a {
        text-decoration: none;
        color: #0056b3;
        font-weight: bold;
    }
    .task-link-container a:hover {
        text-decoration: underline;
    }
    #calendar-container {
      display: none; /* Skjult som standard */
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="grid-head">
    <!-- VENSTRE: MØTEDATA -->
    <div class="card" id="meetingCard">
      <div class="toolbar" style="justify-content:space-between">
        <div style="display:flex;align-items:center;gap:8px">
          <h2 style="margin:0">Møteoversikt & Protokoller</h2>
          <span class="pill ver" title="Versjon"><?= VERSION ?></span>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <span id="statusBadge" class="pill" style="display:none" role="status" aria-live="polite"></span>
          <button id="btnUnlock" class="btn danger" style="display:none">Lås opp</button>
          <span id="liveBadge" class="pill" style="display:none" role="status" aria-live="polite">Oppdateringer</span>
        </div>
      </div>

      <div id="instanceNotice" class="banner info" style="display:none; margin-top: 10px;">
        Dette er en repeterende forekomst. Endringer må gjøres på hovedhendelsen.
      </div>

      <input type="hidden" id="mote-id" />

      <div class="row">
        <div>
          <label>Type</label>
          <select id="type">
            <option>Styremøte</option>
            <option>Generalforsamling</option>
            <option>Ekstraordinært møte</option>
          </select>
        </div>
        <div>
          <label>Dato</label>
          <input id="dato" type="date" required />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Start</label>
          <input id="start" type="time" value="18:00"/>
        </div>
        <div>
          <label>Slutt (valgfritt)</label>
          <input id="slutt" type="time" value="20:00"/>
        </div>
      </div>
      <div>
        <label>Sted</label>
        <input id="sted" placeholder="Fellesrom / Teams-lenke"/>
      </div>
      <div id="video-actions" style="display:none; margin-top: 8px; gap: 8px; align-items: center;">
        <button id="btnJoinVideo" class="btn success" style="padding-left: 12px; padding-right: 12px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>
          Bli med i video
        </button>
        <button id="btnGoToChat" class="btn" title="Gå til chat/innspill" style="padding: 8px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
        </button>
      </div>
      <div>
        <label>Tittel <span class="hint">(påkrevd)</span></label>
        <input id="tittel" placeholder="Styremøte september 2025" required />
      </div>

      <div id="recurrence-section" style="margin-top: 12px; padding: 10px; background-color: #f9f9f9; border-radius: 6px;">
        <label style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="chkRecurrence">
          <strong>Repeterende hendelse</strong>
        </label>
        <div id="recurrence-options" style="display: none; margin-top: 8px; padding-left: 28px;">
          <div class="row">
            <div>
              <label>Frekvens</label>
              <select id="recurrence-frequency">
                <option value="monthly">Månedlig</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Dag</label>
              <select id="recurrence-day">
                <option value="1">Mandag</option>
                <option value="2">Tirsdag</option>
                <option value="3">Onsdag</option>
                <option value="4">Torsdag</option>
                <option value="5">Fredag</option>
                <option value="6">Lørdag</option>
                <option value="0">Søndag</option>
              </select>
            </div>
            <div>
              <label>Uke i måneden</label>
              <select id="recurrence-occurrence">
                <option value="1">Første</option>
                <option value="2">Andre</option>
                <option value="3">Tredje</option>
                <option value="4">Fjerde</option>
                <option value="-1">Siste</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div>
        <label>Deltakere</label>
        <div id="participants-list" class="participants-list"></div>
      </div>

      <div id="conflictBanner" class="banner" style="display:none">
        Endringer er gjort av en annen bruker. <button class="btn ghost" id="btnReload">Last siste</button>
      </div>

      <div class="toolbar">
        <button class="btn primary" id="btnSaveMeeting">Lagre møte</button>
        <button class="btn" id="btnNewMeeting">Nytt møte</button>
        <button class="btn" id="btnSendInnkalling" style="display: none;">Send innkalling</button>
        <button class="btn" id="btnViewProtocol" style="display:none">Vis protokoll</button>
        <button class="btn success" id="btnGenerateProtocol" style="display:none">Generer protokoll</button>
        <span id="saveStatus" class="status"></span>
      </div>
    </div>

    <!-- HØYRE: PLANLAGTE MØTER -->
    <div class="card">
      <div class="toolbar" style="justify-content:space-between">
        <h3 style="margin:0">Planlagte møter</h3>
        <div class="seg">
          <button id="viewToggleList" class="active">Liste</button>
          <button id="viewToggleCalendar">Kalender</button>
        </div>
      </div>
      <div id="list-container">
        <div class="toolbar" style="justify-content:space-between">
          <div class="seg">
            <button id="scopePlanned" class="active">Kommende</button>
            <button id="scopePast">Avholdte</button>
          </div>
        </div>
        <ul id="planned" class="planned list"><li class="hint">Laster…</li></ul>
      </div>
      <div id="calendar-container"></div>
      <div class="toolbar">
        <button class="btn" id="btnRefresh">Oppdater</button>
        <button class="btn" id="btnExportCalendar">Eksporter kalender</button>
      </div>
      <div id="export-container" style="display:none; margin-top: 10px; padding: 8px; background-color: #f7f7f7; border-radius: 4px;">
        <label for="export-url" style="display: block; margin-bottom: 4px;">Kalender-URL (for Google/Outlook):</label>
        <input type="text" id="export-url" readonly style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 3px; background-color: #fff;" onfocus="this.select();" />
        <p class="hint" style="margin-top: 6px; font-size: 0.9em;">Kopier denne lenken og legg den til i din eksterne kalendertjeneste.</p>
      </div>
    </div>
  </div>

  <!-- AGENDA / SAKER -->
  <div class="card" id="agendaCard">
    <div class="toolbar" style="justify-content:space-between">
      <h3 style="margin:0">Agenda</h3>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn success" id="btnNewSak">Ny sak</button>
        <!-- Flytt sak til annet møte (viser når sak valgt) -->
        <div id="moveWrap" style="display:none;align-items:center;gap:6px">
          <select id="moveTo" title="Velg møte å flytte saken til" style="min-width:240px"></select>
          <button class="btn" id="btnMoveSak">Flytt sak</button>
        </div>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Saksnr</label>
        <input id="saksnr" placeholder="S-00XYYYY" disabled />
      </div>
      <div>
        <label>Overskrift for saken</label>
        <input id="sakTittel" />
      </div>
    </div>

    <!-- MM.4.6 Kobling til oppgave -->
    <div id="linkedTask" class="task-link-container">
      Koblet til oppgave: <a href="#" target="_blank" rel="noopener noreferrer"></a>
    </div>

    <label style="margin-top:12px">Innspill</label>
    <div class="hint" id="innspillFrom">Fra: —</div>
    <textarea id="innspillText" placeholder="Skriv innspill for saken …"></textarea>
    <div class="toolbar">
      <button class="btn" id="btnNyttInnspill">Nytt innspill</button>
      <button class="btn primary" id="btnLagreSak">Lagre sak</button>
      <button class="btn danger" id="btnSlettSak">Slett</button>
    </div>

    <div style="margin:6px 0 10px" class="hint">Siste innspill (live):</div>
    <div id="innspillList" class="innspill-list"><div class="hint">Ingen innspill ennå.</div></div>

    <div class="row" style="margin-top:12px">
      <div>
        <label>Forslag til vedtak</label>
        <textarea id="forslagText" placeholder="Teksten det skal stemmes over …"></textarea>
      </div>
      <div>
        <label>Vedtakstekst</label>
        <textarea id="vedtakText" placeholder="Endelig vedtakstekst …"></textarea>
      </div>
    </div>
  </div>

  <!-- SAKSPAPIRER / VEDLEGG -->
  <div class="card" id="documentsCard">
    <div class="toolbar" style="justify-content:space-between">
      <h3 style="margin:0">Sakspapirer</h3>
      <div style="display:flex;gap:8px;align-items:center">
        <input type="file" id="fileUpload" style="display:none" />
        <button class="btn success" id="btnUpload" title="Last opp dokument">Last opp fil</button>
      </div>
    </div>
    <ul id="documentList" class="list"><li class="hint">Ingen dokumenter lastet opp.</li></ul>
  </div>
</div>
<script src="SRC/calendar.js"></script>
<script>
  const $ = s => document.querySelector(s);

  const CONFIG = {
    LOCKED_STATUSES: ['Protokoll under godkjenning', 'Protokoll godkjent', 'Arkivert'],
    VIEWABLE_PROTOCOL_STATUSES: ['Protokoll godkjent', 'Arkivert'],
    CSS_CLASSES: {
        ACTIVE: 'active',
        LOCKED: 'locked',
        VISIBLE: 'visible'
    },
    ELEMENT_IDS: {
        MEETING_CARD: '#meetingCard',
        AGENDA_CARD: '#agendaCard',
        DOCUMENTS_CARD: '#documentsCard',
    },
    FILE_CONFIG: {
        MAX_SIZE: 10 * 1024 * 1024, // 10MB
        ALLOWED_TYPES: [
            'application/pdf',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            'image/jpeg',
            'image/png'
        ]
    }
  };

  let state = { user:null, moteId:null, instanceId: null, sakId:null, lastTick:null, pollTimer:null, pollMs:5000, meetingStatus:null, canUnlock:false, calendarInstance: null };
  const DOM = {};

  function initDOMCache() {
    const ids = [
        'meetingCard', 'agendaCard', 'documentsCard', 'mote-id', 'type', 'dato', 'start',
        'slutt', 'sted', 'tittel', 'participants-list', 'conflictBanner', 'saveStatus',
        'planned', 'calendar-container', 'list-container', 'export-container', 'export-url',
        'statusBadge', 'btnUnlock', 'liveBadge', 'moveWrap', 'moveTo', 'saksnr', 'sakTittel',
        'linkedTask', 'innspillFrom', 'innspillText', 'innspillList', 'forslagText',
        'vedtakText', 'documentList', 'video-actions', 'scopePast', 'scopePlanned',
        'viewToggleList', 'viewToggleCalendar', 'btnGoToChat', 'btnJoinVideo',
        'btnSaveMeeting', 'btnSendInnkalling', 'btnNewMeeting', 'btnRefresh',
        'btnExportCalendar', 'btnViewProtocol', 'btnReload', 'btnNewSak', 'btnLagreSak',
        'btnNyttInnspill', 'btnMoveSak', 'btnUpload', 'fileUpload',
        'instanceNotice', 'recurrence-section', 'chkRecurrence', 'recurrence-options',
        'recurrence-frequency', 'recurrence-day', 'recurrence-occurrence'
    ];
    ids.forEach(id => {
        const key = id.replace(/-([a-z])/g, g => g[1].toUpperCase());
        DOM[key] = $(`#${id}`);
    });
  }

  function handleScriptFailure(err) {
    setStatus(`Feil: ${err.message || 'En ukjent serverfeil oppstod.'}`);
  }

  function validateFile(file) {
    if (file.size > CONFIG.FILE_CONFIG.MAX_SIZE) {
        throw new Error(`Filen er for stor. Maks ${CONFIG.FILE_CONFIG.MAX_SIZE / 1024 / 1024}MB.`);
    }
    if (!CONFIG.FILE_CONFIG.ALLOWED_TYPES.includes(file.type)) {
        throw new Error('Filtype ikke støttet. Kun PDF, Word, Excel og bilder er tillatt.');
    }
    return true;
  }

  function escapeHtml(unsafe) {
    if (typeof unsafe !== 'string') return '';
    return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
  }
  function setStatus(msg){ DOM.saveStatus.textContent = msg||''; }
  function fmtDate(d){ try{ return new Date(d).toLocaleDateString('no-NO'); }catch(_){ return ''; } }
  function toIsoDate(val){
    const s = String(val||'').trim();
    if (!s) return '';
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    const m = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
    if (m){ return `${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`; }
    return s;
  }
  const isLocked = st => !!st && CONFIG.LOCKED_STATUSES.includes(String(st).trim());

  function isValidHttpUrl(string) {
    if (!string || typeof string !== 'string') return false;

    let url;
    try {
        url = new URL(string.trim());
    } catch (_) {
        return false;
    }

    // Only allow safe protocols to prevent XSS via javascript: links
    const safeProtocols = ['http:', 'https:'];
    return safeProtocols.includes(url.protocol);
  }

  function applyLockUI(locked){
    [DOM.agendaCard, DOM.meetingCard, DOM.documentsCard].forEach(root => {
      if (!root) return;
      root.classList.toggle(CONFIG.CSS_CLASSES.LOCKED, !!locked);
      root.querySelectorAll('input,textarea,select').forEach(el => {
        if (el.id === 'saksnr') return;
        el.disabled = !!locked;
      });
      root.querySelectorAll('button').forEach(btn => {
        const id = btn.id || '';
        const whitelist = ['btnUnlock','btnReload','btnRefresh', 'btnExportCalendar'];
        btn.disabled = !!locked && !whitelist.includes(id);
      });
    });
    DOM.moveWrap.style.display = (state.sakId && !locked) ? 'inline-flex' : 'none';
  }

  function applyInstanceLockUI(isInstance) {
    const fieldsToLock = [
        DOM.type, DOM.dato, DOM.start, DOM.slutt, DOM.sted, DOM.tittel,
        DOM.chkRecurrence, DOM.recurrenceFrequency, DOM.recurrenceDay, DOM.recurrenceOccurrence
    ];
    fieldsToLock.forEach(el => {
        if (el) el.disabled = isInstance;
    });

    DOM.btnSaveMeeting.style.display = isInstance ? 'none' : 'inline-block';
    DOM.instanceNotice.style.display = isInstance ? 'block' : 'none';
  }

  function applyInstanceLockUI(isInstance) {
    const fieldsToLock = [
        DOM.type, DOM.dato, DOM.start, DOM.slutt, DOM.sted, DOM.tittel,
        DOM.chkRecurrence, DOM.recurrenceFrequency, DOM.recurrenceDay, DOM.recurrenceOccurrence
    ];
    fieldsToLock.forEach(el => {
        if (el) el.disabled = isInstance;
    });

    DOM.btnSaveMeeting.style.display = isInstance ? 'none' : 'inline-block';
    DOM.instanceNotice.style.display = isInstance ? 'block' : 'none';
  }

  function updateStatusBadge(){
    if (!state.meetingStatus){
        DOM.statusBadge.style.display='none';
        return;
    }
    DOM.statusBadge.textContent = state.meetingStatus;
    DOM.statusBadge.className = 'pill' + (isLocked(state.meetingStatus) ? ' ' + CONFIG.CSS_CLASSES.LOCKED : '');
    DOM.statusBadge.style.display='inline-block';
    DOM.btnUnlock.style.display = (isLocked(state.meetingStatus) && state.canUnlock) ? 'inline-flex' : 'none';
  }

  // init
  google.script.run.withSuccessHandler(res => {
    state.user = res?.user || null;
    initDOMCache(); // Initialize the DOM cache first
    DOM.innspillFrom.textContent = 'Fra: ' + (state.user?.email || '—');
    initializeCalendar();
    refreshMeetings();
    initEventListeners(); // Set up all event listeners
    // Load board members for participant selection
    if (google.script.run.getBoardMembers) {
      google.script.run.withSuccessHandler(drawParticipants).getBoardMembers();
    }
  }).uiBootstrap();

  function initEventListeners() {
    // Video/Chat Actions
    DOM.sted.addEventListener('input', function(e) {
      const url = e.target.value.trim();
      if (isValidHttpUrl(url)) {
        DOM.videoActions.style.display = 'flex';
      } else {
        DOM.videoActions.style.display = 'none';
      }
    });

    DOM.btnJoinVideo.addEventListener('click', function() {
      const url = DOM.sted.value.trim();
      if (isValidHttpUrl(url)) {
        window.open(url, '_blank');
      }
    });

    DOM.btnGoToChat.addEventListener('click', function() {
      DOM.innspillList.scrollIntoView({ behavior: 'smooth', block: 'center' });
      DOM.innspillText.focus();
    });

    // SAVE meeting
    DOM.btnSaveMeeting.addEventListener('click', function(){
        const participants = Array.from(DOM.participantsList.querySelectorAll('input:checked')).map(cb => cb.value);
        const form = {
            moteId: DOM.moteId.value || state.moteId || '',
            type:   DOM.type.value,
            datoISO:  toIsoDate(DOM.dato.value),
            start:  DOM.start.value,
            slutt:  DOM.slutt.value,
            sted:   DOM.sted.value,
            tittel: DOM.tittel.value,
            agenda: '',
            participants: participants,
            recurrence_rule: null
        };

        if (DOM.chkRecurrence.checked) {
            form.recurrence_rule = {
                frequency: DOM.recurrenceFrequency.value,
                day: parseInt(DOM.recurrenceDay.value, 10),
                occurrence: parseInt(DOM.recurrenceOccurrence.value, 10)
            };
        }

        if (!form.tittel.trim()){ setStatus('Møtetittel er påkrevd.'); return; }
        if (!form.datoISO){ setStatus('Velg dato.'); return; }

        setStatus('Lagrer …');
        google.script.run
            .withSuccessHandler((res)=>{
                if (res && res.ok){
                state.moteId = res.id || state.moteId;
                DOM.moteId.value = state.moteId||'';
                setStatus(res.message || 'Lagret.');
                refreshMeetings();
                } else {
                setStatus(res?.message || 'Kunne ikke lagre.');
                }
            })
            .withFailureHandler(handleScriptFailure)
            .upsertMeeting(form);
    });

    DOM.btnSendInnkalling.addEventListener('click', function() {
        if (!state.moteId) {
        setStatus('Velg et møte først.');
        return;
        }
        if (!confirm('Er du sikker på at du vil sende innkalling til alle eiere?')) {
        return;
        }
        setStatus('Sender innkalling...');
        google.script.run
        .withSuccessHandler(res => {
            setStatus(res.message || (res.ok ? 'Innkalling sendt.' : 'En ukjent feil oppstod.'));
        })
        .withFailureHandler(handleScriptFailure)
        .sendInnkalling(state.moteId);
    });

    // Other top-level buttons
    DOM.btnNewMeeting.addEventListener('click', clearMeeting);
    DOM.btnRefresh.addEventListener('click', refreshMeetings);

    DOM.btnExportCalendar.addEventListener('click', function() {
        setStatus('Henter eksport-URL...');
        if (typeof google.script.run.getCalendarExportUrl !== 'function') {
            setStatus('Feil: Funksjonen getCalendarExportUrl er ikke tilgjengelig. Sjekk at CalendarExport.gs er inkludert.');
            DOM.exportUrl.value = 'Funksjonen for eksport er ikke lastet inn.';
            DOM.exportContainer.style.display = 'block';
            return;
        }

        google.script.run
        .withSuccessHandler(res => {
            if (res.ok) {
            DOM.exportUrl.value = res.url;
            DOM.exportContainer.style.display = 'block';
            setStatus('URL for kalendereksport er klar.');
            } else {
            DOM.exportUrl.value = res.message || 'Kunne ikke hente URL.';
            DOM.exportContainer.style.display = 'block';
            setStatus(res.message || 'En feil oppstod.');
            }
        })
        .withFailureHandler(handleScriptFailure)
        .getCalendarExportUrl();
    });

    DOM.btnViewProtocol.addEventListener('click', function(){
        if (!state.moteId) return;
        setStatus('Henter forhåndsvisning...');
        if (!google.script.run.getProtocolPreviewUrl){
        return setStatus('Funksjonen getProtocolPreviewUrl er ikke tilgjengelig.');
        }
        google.script.run
        .withSuccessHandler(res => {
            if (res && res.url) {
            window.open(res.url, '_blank');
            setStatus('Forhåndsvisning åpnet i ny fane.');
            } else {
            setStatus('Kunne ikke hente forhåndsvisning.');
            }
        })
        .withFailureHandler(handleScriptFailure)
        .getProtocolPreviewUrl(state.moteId);
    });

    DOM.btnReload.addEventListener('click', ()=> { if (state.moteId) refreshCurrentMeeting(); });

    // View toggles
    DOM.scopePlanned.addEventListener('click', ()=>{
        DOM.scopePlanned.classList.add(CONFIG.CSS_CLASSES.ACTIVE);
        DOM.scopePast.classList.remove(CONFIG.CSS_CLASSES.ACTIVE);
        refreshMeetings();
    });
    DOM.scopePast.addEventListener('click', ()=>{
        DOM.scopePast.classList.add(CONFIG.CSS_CLASSES.ACTIVE);
        DOM.scopePlanned.classList.remove(CONFIG.CSS_CLASSES.ACTIVE);
        refreshMeetings();
    });
    DOM.viewToggleList.addEventListener('click', () => {
        DOM.listContainer.style.display = 'block';
        DOM.calendarContainer.style.display = 'none';
        DOM.viewToggleList.classList.add(CONFIG.CSS_CLASSES.ACTIVE);
        DOM.viewToggleCalendar.classList.remove(CONFIG.CSS_CLASSES.ACTIVE);
    });
    DOM.viewToggleCalendar.addEventListener('click', () => {
        DOM.listContainer.style.display = 'none';
        DOM.calendarContainer.style.display = 'block';
        DOM.viewToggleCalendar.classList.add(CONFIG.CSS_CLASSES.ACTIVE);
        DOM.viewToggleList.classList.remove(CONFIG.CSS_CLASSES.ACTIVE);
    });

    // Unlock meeting
    DOM.btnUnlock.addEventListener('click', function(){
        if (!state.moteId) return;
        setStatus('Låser opp …');
        if (!google.script.run.unlockMeeting){
        setStatus('Server mangler funksjonen unlockMeeting(moteId).');
        return;
        }
        google.script.run.withSuccessHandler(res=>{
        if (res && res.ok){
            state.meetingStatus = res.status || 'Planlagt';
            updateStatusBadge();
            applyLockUI(false);
            setStatus('Møtet er låst opp.');
        } else {
            setStatus(res?.message || 'Kunne ikke låse opp.');
        }
        }).withFailureHandler(handleScriptFailure).unlockMeeting(state.moteId);
    });

    // Agenda/Sak actions
    DOM.btnNewSak.addEventListener('click', function(){
        if (!state.moteId){ setStatus('Lagre eller velg et møte først.'); return; }
        setStatus('Oppretter ny sak...');
        google.script.run.withSuccessHandler(res=>{
        if (!res || !res.ok) { setStatus(res?.message||'Kunne ikke opprette sak.'); return; }
        state.sakId = res.sakId; DOM.saksnr.value=res.saksnr; DOM.sakTittel.value='';
        DOM.innspillText.value=''; DOM.forslagText.value=''; DOM.vedtakText.value='';
        setStatus('Ny sak opprettet. Du kan nå skrive inn tittel og detaljer.');
        loadMoveTargets();
        }).newAgendaItem(state.moteId);
    });

    DOM.btnLagreSak.addEventListener('click', function(){
        if (!state.sakId){ setStatus('Opprett eller velg en sak først.'); return; }
        setStatus('Lagrer sak...');
        const payload = {
            sakId: state.sakId,
            tittel: DOM.sakTittel.value,
            forslag: DOM.forslagText.value,
            vedtak:  DOM.vedtakText.value
        };
        google.script.run
            .withSuccessHandler(_=> setStatus('Sak lagret.'))
            .withFailureHandler(handleScriptFailure)
            .saveAgenda(payload);
    });

    DOM.btnNyttInnspill.addEventListener('click', function(){
        if (!state.sakId){ setStatus('Opprett eller velg en sak først.'); return; }
        const txt = (DOM.innspillText.value||'').trim();
        if (!txt){ setStatus('Skriv et innspill først.'); return; }
        setStatus('Sender innspill...');
        google.script.run
            .withSuccessHandler(_=>{
                DOM.innspillText.value='';
                setStatus('Innspill lagret.');
            })
            .withFailureHandler(handleScriptFailure)
            .appendInnspill(state.sakId, txt);
    });

    DOM.btnMoveSak.addEventListener('click', function(){
        if (!state.sakId){ setStatus('Velg en sak først.'); return; }
        const toId = DOM.moveTo.value;
        if (!toId){ setStatus('Velg mål-møte.'); return; }
        if (!google.script.run.moveAgendaToMeeting){
        setStatus('Server mangler funksjonen moveAgendaToMeeting(sakId, toMoteId).');
        return;
        }
        setStatus('Flytter sak …');
        google.script.run.withSuccessHandler(res=>{
        if (res && res.ok){
            setStatus('Sak flyttet.');
            clearSak();
            DOM.innspillList.innerHTML = '<div class="hint">Ingen innspill ennå.</div>';
        } else {
            setStatus(res?.message || 'Kunne ikke flytte sak.');
        }
        }).withFailureHandler(handleScriptFailure).moveAgendaToMeeting(state.sakId, toId);
    });

    function loadMoveTargets(){
        if (!state.moteId) return;
        google.script.run
            .withSuccessHandler(meetings => {
            DOM.moveTo.innerHTML = '<option value="">-- Velg møte --</option>';
            (meetings || []).forEach(m => {
                if (m.id !== state.moteId && !isLocked(m.status)) {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.textContent = `${m.tittel || m.type} - ${fmtDate(m.dato)}`;
                DOM.moveTo.appendChild(opt);
                }
            });
            DOM.moveWrap.style.display = state.sakId ? 'inline-flex' : 'none';
            })
            .listMeetings_({scope: 'all'});
    }

    // File upload
    DOM.btnUpload.addEventListener('click', () => {
        if (!state.moteId) {
        setStatus('Lagre eller velg et møte først.');
        return;
        }
        DOM.fileUpload.click();
    });

    DOM.fileUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        try {
            validateFile(file);
        } catch (err) {
            setStatus(err.message);
            e.target.value = '';
            return;
        }

        setStatus('Laster opp fil...');
        const reader = new FileReader();
        reader.onload = (event) => {
            const fileData = event.target.result;
            google.script.run
                .withSuccessHandler(res => {
                    if (res.ok) {
                        setStatus('Dokument lastet opp.');
                        if (state.moteId) {
                            google.script.run.withSuccessHandler(drawDocuments).listMeetingDocuments(state.moteId);
                        }
                    } else {
                        setStatus(res.message || 'Kunne ikke laste opp fil.');
                    }
                })
                .withFailureHandler(handleScriptFailure)
                .addMeetingDocument(state.moteId, fileData, file.name);
        };
        reader.readAsDataURL(file);
        e.target.value = ''; // Clear input
    });

    // Optimize polling by pausing when the tab is not visible
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            stopPolling();
        } else {
            if (state.moteId) {
                startPolling();
            }
        }
    });

    DOM.btnGenerateProtocol.addEventListener('click', function(){
        if (!state.moteId) return;
        setStatus('Genererer protokoll...');
        google.script.run
            .withSuccessHandler(res => {
                if (res.ok) {
                    setStatus('Protokoll generert.');
                    refreshCurrentMeeting();
                } else {
                    setStatus(res.message || 'Kunne ikke generere protokoll.');
                }
            })
            .withFailureHandler(handleScriptFailure)
            .generateProtocol(state.moteId);
    });
  }

  function initializeCalendar() {
    state.calendarInstance = new calendar(DOM.calendarContainer, {
      abbrDay: true,
      onEventClick: (evt) => {
        if (evt.type === 'task') {
          // Could potentially link to the task view in the future.
          // For now, just log it and do nothing.
          console.log('Task event clicked:', evt);
          return;
        }
        loadMeeting(evt.meetingData);
      },
      onDayClick: (date, evts) => {
        if (evts.length > 0) {
          const firstMeeting = evts.find(e => e.type !== 'task');
          if (firstMeeting) {
            loadMeeting(firstMeeting.meetingData);
          }
        }
      }
    });
  }

  function drawParticipants(members) {
    DOM.participantsList.innerHTML = '';
    if (!members || !members.length) {
      DOM.participantsList.innerHTML = '<div class="hint">Ingen styremedlemmer funnet.</div>';
      return;
    }
    members.forEach(p => {
      const item = document.createElement('div');
      item.className = 'participant-item';
      item.innerHTML = `<label><input type="checkbox" name="participants" value="${escapeHtml(p.email)}"> ${escapeHtml(p.name)}</label>`;
      DOM.participantsList.appendChild(item);
    });
  }

  function refreshMeetings() {
    DOM.planned.innerHTML = '<li class="hint">Laster…</li>';
    google.script.run.withSuccessHandler(meetingsResponse => {
      // Etter at møter er hentet, hent oppgaver
      if (google.script.run.gjoremalGet) {
        google.script.run.withSuccessHandler(tasksResponse => {
          const meetings = (meetingsResponse && meetingsResponse.length) ? meetingsResponse : [];
          const tasks = (tasksResponse && tasksResponse.ok) ? tasksResponse.tasks : [];
          drawCalendarEvents(meetings, tasks);
        }).gjoremalGet();
      } else {
        drawCalendarEvents(meetingsResponse || [], []);
      }
    }).listMeetings_({scope: 'all'});
  }

  function drawCalendarEvents(list, tasks){
    const ul = DOM.planned;
    ul.innerHTML='';

    // Clear existing events from calendar
    state.calendarInstance.events = [];

    if ((!list || !list.length) && (!tasks || !tasks.length)) {
      ul.innerHTML = '<li class="hint">Ingen møter eller oppgaver i listen.</li>';
      state.calendarInstance.drawCalendar();
      return;
    }

    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];

    const scope = DOM.scopePast.classList.contains(CONFIG.CSS_CLASSES.ACTIVE) ? 'past' : 'planned';
    const filteredList = list.filter(m => {
        if (!m.dato) return scope === 'planned';
        const meetingDate = m.dato instanceof Date ? m.dato : new Date(m.dato);
        const meetingStr = meetingDate.toISOString().split('T')[0];
        return scope === 'past' ? meetingStr < todayStr : meetingStr >= todayStr;
    });

    if (filteredList.length === 0) {
      ul.innerHTML = '<li class="hint">Ingen møter i listen for valgt periode.</li>';
    }

    filteredList.forEach(m => {
      const li = document.createElement('li');
      li.innerHTML = `<strong>${escapeHtml(m.tittel||m.type)}</strong><br>${escapeHtml(m.type)} • ${m.dato?fmtDate(m.dato):''} • ${escapeHtml(m.start||'')} • ${escapeHtml(m.sted||'')}`;
      li.style.cursor='pointer';
      li.addEventListener('click', () => loadMeeting(m));
      ul.appendChild(li);
    });

    // Populate calendar
    let events = [];
    if (list && list.length) {
      events = events.concat(list.map(m => ({
        date: new Date(m.dato),
        desc: m.tittel,
        meetingData: m,
        type: 'meeting' // Å.5.3
      })));
    }

    if (tasks && tasks.length) {
      const taskEvents = tasks.filter(t => t.dueDate).map(t => ({
        date: new Date(t.dueDate),
        desc: `Frist: ${t.title}`,
        meetingData: { id: `task-${t.id}`, tittel: `Frist: ${t.title}` }, // Mock meeting data
        type: 'task', // Å.5.3
        className: 'event-task' // Custom class for styling
      }));
      events = events.concat(taskEvents);
    }

    state.calendarInstance.events = events;
    state.calendarInstance.drawCalendar();
  }

  function loadMeeting(m){
    if (m.isRecurringInstance) {
      state.instanceId = m.id;
      state.moteId = m.baseId;
    } else {
      state.instanceId = null;
      state.moteId = m.id;
    }
    state.meetingStatus = m.status || 'Planlagt';
    DOM.moteId.value = state.moteId;
    DOM.type.value  = m.type||'Styremøte';
    DOM.dato.value  = m.dato ? new Date(m.dato).toISOString().slice(0,10) : '';
    DOM.start.value = m.start||'';
    DOM.slutt.value = m.slutt||'';
    DOM.sted.value  = m.sted||'';
    DOM.tittel.value= m.tittel||'';

    // Recurrence
    const recurrenceRule = m.recurrence_rule;
    if (recurrenceRule && typeof recurrenceRule === 'object') {
      DOM.chkRecurrence.checked = true;
      DOM.recurrenceOptions.style.display = 'block';
      DOM.recurrenceFrequency.value = recurrenceRule.frequency || 'monthly';
      DOM.recurrenceDay.value = recurrenceRule.day || '1';
      DOM.recurrenceOccurrence.value = recurrenceRule.occurrence || '1';
    } else {
      DOM.chkRecurrence.checked = false;
      DOM.recurrenceOptions.style.display = 'none';
    }

    // Clear and set participants
    DOM.participantsList.querySelectorAll('input').forEach(box => box.checked = false);
    if (m.participants && m.participants.length) {
      m.participants.forEach(email => {
        const cb = DOM.participantsList.querySelector(`input[value="${escapeHtml(email)}"]`);
        if (cb) cb.checked = true;
      });
    }

    setStatus('Møte lastet.');
    DOM.conflictBanner.style.display = 'none';
    DOM.liveBadge.style.display = 'none';
    DOM.innspillList.innerHTML = '<div class="hint">Ingen innspill ennå.</div>';
    updateStatusBadge();
    applyLockUI(isLocked(state.meetingStatus));
    applyInstanceLockUI(m.isRecurringInstance);
    DOM.btnViewProtocol.style.display = CONFIG.VIEWABLE_PROTOCOL_STATUSES.includes(state.meetingStatus) ? 'inline-block' : 'none';
    DOM.btnSendInnkalling.style.display = (state.moteId && !isLocked(state.meetingStatus)) ? 'inline-block' : 'none';
    DOM.btnGenerateProtocol.style.display = (state.moteId && !isLocked(state.meetingStatus)) ? 'inline-block' : 'none';

    // Show/hide video actions
    if (isValidHttpUrl(m.sted)) {
      DOM.videoActions.style.display = 'flex';
    } else {
      DOM.videoActions.style.display = 'none';
    }

    // RBAC: kan låse opp?
    if (google.script.run.hasPermission){
      google.script.run.withSuccessHandler(can=>{
        state.canUnlock = !!can;
        updateStatusBadge();
      }).hasPermission('MEETING_UNLOCK');
    }

    // last første sak (om finnes)
    google.script.run.withSuccessHandler(saker=>{
      if (!saker || !saker.length){ clearSak(); startPolling(); return; }
      const s = saker[0];
      state.sakId = s.sakId;
      DOM.saksnr.value = s.saksnr||'';
      DOM.sakTittel.value = s.tittel||'';
      DOM.innspillText.value = '';
      DOM.forslagText.value = s.forslag||'';
      DOM.vedtakText.value = s.vedtak||'';

      // MM.4.6: Vis koblet oppgave hvis den finnes
      if (s.kobletOppgave && s.kobletOppgave.id) {
        const link = DOM.linkedTask.querySelector('a');
        link.href = s.kobletOppgave.link || '#';
        link.textContent = escapeHtml(s.kobletOppgave.tittel || `Oppgave #${s.kobletOppgave.id}`);
        DOM.linkedTask.classList.add(CONFIG.CSS_CLASSES.VISIBLE);
      } else {
        DOM.linkedTask.classList.remove(CONFIG.CSS_CLASSES.VISIBLE);
      }

      startPolling();
      if (state.sakId){
        if (google.script.run.listInnspill){
          google.script.run.withSuccessHandler(drawInnspill).listInnspill(state.sakId, null);
        }
        loadMoveTargets();
      }
    }).listAgenda(state.moteId);

    // Load documents
    if (google.script.run.listMeetingDocuments) {
      google.script.run.withSuccessHandler(drawDocuments).listMeetingDocuments(state.moteId);
    }
  }

  function drawDocuments(docs) {
    const ul = DOM.documentList;
    ul.innerHTML = '';
    if (!docs || !docs.length) {
      ul.innerHTML = '<li class="hint">Ingen dokumenter lastet opp.</li>';
      return;
    }
    const isMeetLocked = isLocked(state.meetingStatus);
    docs.forEach(doc => {
      const li = document.createElement('li');
      li.innerHTML = `<a href="${doc.drive_url}" target="_blank">${escapeHtml(doc.dokumentnavn)}</a>`;

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn danger small';
      deleteBtn.textContent = 'Slett';
      deleteBtn.disabled = isMeetLocked;
      deleteBtn.addEventListener('click', () => deleteDocument(doc.id));

      li.appendChild(deleteBtn);
      ul.appendChild(li);
    });
  }

  function deleteDocument(docId) {
    if (!docId) return;
    if (!confirm('Er du sikker på at du vil slette dette dokumentet?')) return;
    setStatus('Sletter dokument...');
    google.script.run
      .withSuccessHandler(res => {
        if (res.ok) {
          setStatus('Dokument slettet.');
          if (state.moteId) {
            google.script.run.withSuccessHandler(drawDocuments).listMeetingDocuments(state.moteId);
          }
        } else {
          setStatus(res.message || 'Kunne ikke slette dokument.');
        }
      })
      .withFailureHandler(err => setStatus(err.message || 'En feil oppstod.'))
      .deleteMeetingDocument(docId);
  }

  function createInnspillElement(item) {
    const el = document.createElement('div');
    el.className = 'innspill-item';
    const ts = item.ts ? new Date(item.ts).toLocaleString('no-NO') : '';
    el.innerHTML = `<div class="hint">${ts} • ${item.from || 'ukjent'}</div><div>${escapeHtml(item.text || '')}</div>`;
    return el;
  }

  function drawInnspill(items){
    const box = DOM.innspillList;
    box.innerHTML = ''; // Always clear first
    if (!items || !items.length) {
        box.innerHTML = '<div class="hint">Ingen innspill ennå.</div>';
        return; 
    }
    items.forEach(x => {
      box.appendChild(createInnspillElement(x));
    });
    box.scrollTop = box.scrollHeight;
  }

  function clearMeeting(){
    stopPolling();
    state.moteId=null; state.instanceId=null; state.meetingStatus=null; state.canUnlock=false;
    DOM.moteId.value='';
    DOM.type.value='Styremøte'; DOM.dato.value=''; DOM.start.value='18:00'; DOM.slutt.value='20:00';
    DOM.sted.value=''; DOM.tittel.value='';

    // Clear recurrence
    DOM.chkRecurrence.checked = false;
    DOM.recurrenceOptions.style.display = 'none';
    DOM.recurrenceFrequency.value = 'monthly';
    DOM.recurrenceDay.value = '1';
    DOM.recurrenceOccurrence.value = '1';

    setStatus('');
    clearSak();
    updateStatusBadge();
    applyLockUI(false);
    applyInstanceLockUI(false);
    DOM.btnViewProtocol.style.display = 'none';
    DOM.btnSendInnkalling.style.display = 'none';
    DOM.innspillList.innerHTML = '<div class="hint">Ingen innspill ennå.</div>';
  }
  function clearSak(){
    state.sakId=null; DOM.saksnr.value=''; DOM.sakTittel.value='';
    DOM.innspillText.value=''; DOM.forslagText.value=''; DOM.vedtakText.value='';
    DOM.moveWrap.style.display='none';
    DOM.linkedTask.classList.remove(CONFIG.CSS_CLASSES.VISIBLE); // MM.4.6: Skjul oppgavelenke
  }

  // All event handlers are now in initEventListeners()

  // ------- NESTEN-SANNTID POLLING -------
  function startPolling(){
    stopPolling();
    state.lastTick = null;
    if (!google.script.run.rtServerNow) return;
    google.script.run.withSuccessHandler(x=>{
      state.lastTick = x?.now || new Date().toISOString();
      state.pollMs = 5000;
      state.pollTimer = setInterval(doPoll, state.pollMs);
    }).rtServerNow();
  }
  function stopPolling(){
    if (state.pollTimer){ clearInterval(state.pollTimer); state.pollTimer=null; }
  }
  function adjustPolling(hasActivity){
    state.pollMs = hasActivity ? 5000 : Math.min(30000, state.pollMs + 5000);
    if (state.pollTimer){
      clearInterval(state.pollTimer);
      state.pollTimer = setInterval(doPoll, state.pollMs);
    }
  }
  function doPoll(){
    if (!state.moteId || !google.script.run.rtGetChanges) return;
    google.script.run
        .withSuccessHandler(ch=>{
            if (!ch) return;
            let activity = false;
            if (ch.meetingUpdated){
                DOM.conflictBanner.style.display='block'; DOM.liveBadge.style.display='inline-block'; activity = true;
                if (ch.meetingStatus){
                state.meetingStatus = ch.meetingStatus;
                updateStatusBadge();
                applyLockUI(isLocked(state.meetingStatus));
                }
            }
            if (ch.updatedSaker && ch.updatedSaker.length){
                const hit = ch.updatedSaker.find(s => s.sakId === state.sakId);
                if (hit){
                const ae = document.activeElement || {};
                const typing = (ae.tagName === 'INPUT' || ae.tagName === 'TEXTAREA');
                if (!typing){
                    DOM.sakTittel.value = hit.tittel ?? DOM.sakTittel.value;
                    DOM.forslagText.value = hit.forslag ?? DOM.forslagText.value;
                    DOM.vedtakText.value  = hit.vedtak  ?? DOM.vedtakText.value;
                } else {
                    DOM.conflictBanner.style.display='block';
                }
                DOM.liveBadge.style.display='inline-block';
                activity = true;
                }
            }
            if (ch.newInnspill && ch.newInnspill.length){
                if (state.sakId){
                const relevant = ch.newInnspill.filter(x => x.sakId === state.sakId);
                if (relevant.length){
                    appendInnspillToList(relevant);
                    DOM.liveBadge.style.display='inline-block';
                    activity = true;
                }
                }
            }
            state.lastTick = ch.serverNow || new Date().toISOString();
            adjustPolling(activity);
        })
        .withFailureHandler(err => {
            console.error('Polling error:', err);
            // Don't stop polling on transient errors, just slow it down.
            adjustPolling(false);
        })
        .rtGetChanges(state.moteId, state.lastTick);
  }

  function refreshCurrentMeeting(){
    google.script.run.withSuccessHandler(list=>{
      const m = (list||[]).find(x => x.id === state.moteId);
      if (m){ loadMeeting(m); }
      DOM.conflictBanner.style.display = 'none';
      DOM.liveBadge.style.display = 'none';
    }).listMeetings_({scope: DOM.scopePast.classList.contains('active') ? 'past' : 'planned'});
  }

  function appendInnspillToList(items){
    const box = DOM.innspillList;
    if (box.children.length === 1 && box.querySelector('.hint')) {
        box.innerHTML = '';
    }
    items.forEach(x => {
        box.appendChild(createInnspillElement(x));
    });
    box.scrollTop = box.scrollHeight;
  }

</script>
</body>
</html>
