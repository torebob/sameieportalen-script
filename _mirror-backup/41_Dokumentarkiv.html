<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>Dokumentarkiv</title>
    <base target="_top">
    <style>
      :root{--bg:#0b1220;--card:#0f172a;--muted:#94a3b8;--border:#1f2937;--primary:#3b82f6;--success:#10b981;--warning:#f59e0b;--danger:#ef4444}
      *{box-sizing:border-box}
      body{margin:0;padding:12px;font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,system-ui,sans-serif;background:var(--bg);color:#fff;line-height:1.5}
      main {max-width: 900px; margin: 0 auto;}
      h1 { border-bottom: 1px solid var(--border); padding-bottom: 8px; }
      .upload-section { background: var(--card); padding: 24px; border-radius: 8px; margin-bottom: 24px; }
      .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        cursor: pointer;
        background-color: var(--primary);
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        margin-top: 10px;
      }
      .file-input-wrapper input[type=file] {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        cursor: pointer;
        width: 100%;
        height: 100%;
      }
      #file-name { margin-left: 15px; color: var(--muted); }
      #upload-btn {
        background-color: var(--success);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 10px;
        opacity: 0.7;
      }
      #upload-btn.ready {
        opacity: 1;
      }
      .document-table { width: 100%; border-collapse: collapse; margin-top: 24px; }
      .document-table th, .document-table td { border: 1px solid var(--border); padding: 12px; text-align: left; }
      .document-table th { background-color: var(--bg); }
      .document-table a { color: var(--primary); text-decoration: none; }
      .document-table a:hover { text-decoration: underline; }
      .loader { display: none; margin-top: 10px; }
    </style>
</head>
<body>
    <main>
        <h1>Dokumentarkiv</h1>
        <p>Her kan du laste opp og se viktige dokumenter for sameiet.</p>

        <section class="upload-section">
            <h2>Last opp nytt dokument</h2>
            <form id="upload-form">
                <div class="file-input-wrapper">
                    <span>Velg fil</span>
                    <input type="file" id="file-input" name="file">
                </div>
                <span id="file-name">Ingen fil valgt</span>
                <button type="submit" id="upload-btn" disabled>Last opp</button>
                <div id="loader" class="loader">Laster opp...</div>
            </form>
        </section>

        <section class="archive-section">
            <h2>Arkiverte dokumenter</h2>
            <table class="document-table">
                <thead>
                    <tr>
                        <th>Filnavn</th>
                        <th>Format</th>
                        <th>Opplastet dato</th>
                        <th>Størrelse</th>
                        <th>Handlinger</th>
                    </tr>
                </thead>
                <tbody id="document-list">
                    <!-- Rader med dokumenter blir satt inn her -->
                </tbody>
            </table>
        </section>
    </main>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const uploadForm = document.getElementById('upload-form');
        const fileInput = document.getElementById('file-input');
        const fileNameSpan = document.getElementById('file-name');
        const uploadBtn = document.getElementById('upload-btn');
        const loader = document.getElementById('loader');
        const documentList = document.getElementById('document-list');

        fileInput.addEventListener('change', () => {
          if (fileInput.files.length > 0) {
            fileNameSpan.textContent = fileInput.files[0].name;
            uploadBtn.disabled = false;
            uploadBtn.classList.add('ready');
          } else {
            fileNameSpan.textContent = 'Ingen fil valgt';
            uploadBtn.disabled = true;
            uploadBtn.classList.remove('ready');
          }
        });

        uploadForm.addEventListener('submit', (e) => {
          e.preventDefault();
          if (fileInput.files.length === 0) {
            alert('Vennligst velg en fil først.');
            return;
          }

          loader.style.display = 'block';
          uploadBtn.disabled = true;
          uploadBtn.classList.remove('ready');

          const file = fileInput.files[0];
          const fr = new FileReader();
          fr.onload = (event) => {
            const fileData = {
              fileName: file.name,
              mimeType: file.type,
              data: event.target.result.split(',')[1]
            };
            google.script.run
              .withSuccessHandler(response => {
                loader.style.display = 'none';
                if (response.ok) {
                  alert('Filen ble lastet opp!');
                  resetForm();
                  loadDocuments();
                } else {
                  alert('Opplasting feilet: ' + response.message);
                  uploadBtn.disabled = false;
                  uploadBtn.classList.add('ready');
                }
              })
              .withFailureHandler(err => {
                loader.style.display = 'none';
                alert('En feil oppsto: ' + err.message);
                uploadBtn.disabled = false;
                uploadBtn.classList.add('ready');
              })
              .uploadFileToDrive(fileData);
          };
          fr.readAsDataURL(file);
        });

        function resetForm() {
            uploadForm.reset();
            fileNameSpan.textContent = 'Ingen fil valgt';
            uploadBtn.disabled = true;
            uploadBtn.classList.remove('ready');
        }

        function loadDocuments() {
          google.script.run
            .withSuccessHandler(files => {
              documentList.innerHTML = ''; // Tøm listen
              if (files && files.length > 0) {
                files.forEach(file => {
                  const row = document.createElement('tr');
                  row.innerHTML = `
                    <td><a href="${file.url}" target="_blank">${file.name}</a></td>
                    <td>${file.mimeType}</td>
                    <td>${new Date(file.createdDate).toLocaleDateString('no-NO')}</td>
                    <td>${(file.size / 1024).toFixed(2)} KB</td>
                    <td><button onclick="deleteFile('${file.id}')">Slett</button></td>
                  `;
                  documentList.appendChild(row);
                });
              } else {
                documentList.innerHTML = '<tr><td colspan="5">Ingen dokumenter funnet.</td></tr>';
              }
            })
            .withFailureHandler(err => {
              alert('Kunne ikke hente dokumenter: ' + err.message);
            })
            .listFilesInDriveFolder();
        }

        window.deleteFile = function(fileId) {
            if (!confirm('Er du sikker på at du vil slette denne filen?')) {
                return;
            }
            google.script.run
                .withSuccessHandler(response => {
                    if(response.ok) {
                        alert('Fil slettet!');
                        loadDocuments();
                    } else {
                        alert('Feil ved sletting: ' + response.message);
                    }
                })
                .withFailureHandler(err => {
                    alert('En feil oppsto: ' + err.message);
                })
                .deleteFileFromDrive(fileId);
        }

        loadDocuments();
      });
    </script>
</body>
</html>